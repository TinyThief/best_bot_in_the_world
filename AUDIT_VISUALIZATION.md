# Аудит визуализации свечного графика

Проверка алгоритма построения графика в `src/utils/backtest_chart.py` (build_candlestick_trend_chart) и цепочки данных.

---

## 1. Цепочка данных (проверено)

| Этап | Где | Порядок/формат | Статус |
|------|-----|----------------|--------|
| БД | `database.get_candles(..., order_asc=False)` | SELECT ORDER BY start_time DESC LIMIT N → затем `reverse()` → **от старых к новым** | ✓ |
| Telegram /chart | `_run_candlestick_chart(..., limit=1500)` | Передаёт в build_candlestick_trend_chart список **[oldest … newest]** | ✓ |
| Срез | `candles[-max_candles_display:]` при n_total > 500 | Берём **последние** 500 элементов = 500 самых новых, порядок сохранён | ✓ |
| Массивы | `opens, highs, lows, closes` из `candles` по порядку | `opens[i]` соответствует свече с индексом i (i=0 — слева, старая; i=n-1 — справа, новая) | ✓ |

**Вывод:** Ось X: слева — старые даты, справа — новые. Инфобокс «Последняя свеча» использует `opens[-1], highs[-1], ...` — это последняя (новая) свеча на графике. Согласованно.

---

## 2. Геометрия свечи (проверено и исправлено)

- **Тело:** прямоугольник от `min(open, close)` до `max(open, close)`. Цвет: зелёный при close ≥ open, красный при close < open.
- **Нижняя тень:** отрезок от `low` до низа тела `body_bottom`.
- **Верхняя тень:** отрезок от верха тела до `high`.

**Дожи (open == close):** тело нулевой высоты не видно. Исправление: рисуем тело с минимальной высотой `body_height_draw = max(body_height_real, min_body_height)`; верхняя тень начинается от **верха рисованного тела** `body_top_draw = body_bottom + body_height_draw`, чтобы не было разрыва между телом и тенью.

**Порядок отрисовки:** сначала тени, затем тело (Rectangle). Тело перекрывает место стыка теней — корректно.

---

## 3. Масштаб и оси

- **Y:** `y_min_glob`, `y_max_glob` — минимум/максимум по `lows`, `opens`, `highs`, `closes`. Лимиты оси: ±1% от диапазона. Масштаб **не** меняется (scale_correction=False по умолчанию) — цены как в данных.
- **X:** от -0.5 до n-0.5; свеча с индексом i центрирована в i, ширина тела `width` (зависит от n).
- Подписи оси X: даты из `candles[i]["start_time"]`; если > 1e10 — считаем миллисекунды, иначе секунды.

---

## 4. Фильтры (текущее состояние)

- **В build_candlestick_trend_chart (BTC):** отбрасываются только свечи, у которых хотя бы одно значение OHLC **вне** 1_000–500_000 USDT. По волатильности **не** фильтруем — иначе последние волатильные свечи пропадали и «последняя свеча» оказывалась старой.
- **В exchange._filter_valid_ohlc:** при загрузке с биржи отсекаются свечи вне диапазона и с абсурдным (high-low)/open > 1.5.

---

## 5. Возможные источники ошибок

| Риск | Что проверить / что сделано |
|------|-----------------------------|
| В БД записаны старые данные | «Последняя свеча» будет с прошлой даты. Решение: `python catch_up_db.py` или `python refresh_db.py --yes`. |
| start_time в секундах вместо мс | Проверка `> 1e10` выбирает деление на 1000 для подписи даты. Bybit отдаёт мс — ок. |
| Одна битая свеча (OHLC неконсистентны) | Стандарт: low ≤ open, close ≤ high. Если в данных нарушено — свеча может рисоваться криво. При необходимости можно добавить clamp при отрисовке. |
| Цены > 500k (BTC) | Фильтр в графике и в exchange отсекает — такие свечи не попадают в БД/график. При необходимости поднять лимит в config/exchange. |

---

## 6. Внесённые исправления (аудит 2026-01-30)

1. **Дожи:** введены `body_height_draw` и `body_top_draw`; верхняя тень рисуется от `body_top_draw` до `high`, тело — от `body_bottom` до `body_top_draw`. Нет разрыва между телом и верхней тенью.
2. **Фильтр в графике:** только проверка цен 1k–500k для BTC, без отсечки по волатильности.
3. **Масштаб:** scale_correction по умолчанию False — ось Y в реальных ценах.
4. **Инфобокс:** добавлена строка «Диапазон на графике: min – max» для сверки с TradingView.

---

## 7. Рекомендации

- После изменений в данных или фильтрах проверять график командой `/chart` или скриптом, вызывающим `build_candlestick_trend_chart`.
- При расхождении цен с TradingView: проверить актуальность БД (`catch_up_db` / `refresh_db`) и лимиты фильтра цен (1k–500k).
