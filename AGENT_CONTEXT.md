# Контекст для агента (AI)

**Читай этот файл в начале новой сессии.** В нём — состояние проекта, что сделано, что в процессе, что запланировано. Обновляй разделы по мере работы.

---

## Проект в двух словах

**Мультитаймфреймовый торговый бот для Bybit.** Цель: торговля с опорой на несколько таймфреймов (тренд со старшего, вход с младшего). Стек: Python, pybit, SQLite, .env-конфиг. Пара по умолчанию — фьючерс **BTCUSDT** (linear).

---

## Сделано (DONE)

- **exchange.py** — клиент Bybit REST V5: `get_klines`, `get_klines_multi_timeframe`, `fetch_klines_backfill` (пагинация по 1000, лимит вглубь задаётся). Свечи: start_time, open, high, low, close, volume.
- **config.py** — загрузка .env, константы для Bybit, торговли и БД. `validate_config()`.
- **database.py** — SQLite, таблица `klines(symbol, timeframe, start_time, open, high, low, close, volume)`, PK (symbol, timeframe, start_time). Функции: init_db, get_connection, insert_candles, get_latest_start_time, get_oldest_start_time, count_candles.
- **accumulate_db.py** — скрипт накопления: по каждому ТФ из TIMEFRAMES_DB при отсутствии данных — бэкфилл до BACKFILL_MAX_CANDLES, затем раз в DB_UPDATE_INTERVAL_SEC дотягивание новых свечей. Запуск: `python accumulate_db.py`.
- **multi_tf.py** — мультитаймфреймовый анализ: запрос свечей по TIMEFRAMES, простой тренд up/down/flat по последним свечам, сигнал long/short/none по старшему ТФ. Данные только с биржи, не из БД.
- **main.py** — цикл опроса multi_tf и лог сигналов. Запуск: `python main.py`. Сделок нет.
- **ДЛЯ_КОМАНДЫ.md** — онбординг для людей: структура, файлы, связи, .env, как запускать.
- **release.py** — версии и выгрузка в GitHub: создание тега (vX.Y.Z), при необходимости коммит, push ветки и тегов. Откат: `git checkout v1.0.0`. Запуск: `python release.py 1.0.0`, опции `--tag-only`, `--no-push`.
- БД накапливается в `data/klines.db`, по 13 ТФ (1,3,5,15,30,60,120,240,360,720,D,W,M), объёмы в колонке `volume`.

---

## В процессе (IN PROGRESS)

- *Пока пусто. Сюда добавлять задачи, над которыми идёт работа.*

---

## Планируем (PLANNED)

- Индикаторы на выбранных ТФ (MA, RSI, уровни и т.п.).
- Исполнение ордеров через Bybit API по сигналу из multi_tf.
- Риск-менеджмент: размер позиции, стоп-лосс, тейк-профит.
- Использование БД для обучения моделей (чтение из klines по symbol/timeframe/диапазону).
- При желании — поддержка нескольких пар и отдельная конфигурация стратегии.

---

## Куда смотреть по задачам

| Задача | Файлы / места |
|--------|----------------|
| Пара, ТФ, лимиты, интервалы | config.py, .env |
| Запросы к Bybit, бэкфилл | exchange.py |
| Схема БД, вставка, выборки | database.py |
| Накопление свечей | accumulate_db.py |
| Логика сигнала, тренды | multi_tf.py |
| Цикл и лог | main.py |
| Версии, теги, push в GitHub, откат | release.py |
| Онбординг человека | ДЛЯ_КОМАНДЫ.md |

---

## Важные договорённости

- Конфиг только из .env через config.py.
- Для чтения свечей ключи API не нужны; для сделок — нужны BYBIT_API_KEY/SECRET.
- По умолчанию BYBIT_TESTNET=true. Не коммитить .env.
- База — один SQLite-файл (DB_PATH), каталог data/ в .gitignore.
- Версии — теги git (v1.0.0 и т.п.), создаются через `python release.py X.Y.Z`. Откат — `git checkout vX.Y.Z`.

---

## Как обновлять этот файл

- Завершил фичу из PLANNED → перенеси в DONE, кратко что сделано.
- Начал задачу → добавь в IN PROGRESS с пометкой, что именно делаешь.
- Появилась новая цель → добавь в PLANNED.
- Менялась архитектура или соглашения → обнови «Куда смотреть» и «Важные договорённости».
