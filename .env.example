# Bybit API (храни в .env, не коммить ключи)
BYBIT_API_KEY=
BYBIT_API_SECRET=

# Testnet: true = тестовая сеть, false = боевая
BYBIT_TESTNET=true

# Торговый режим: linear (USDT-M), inverse, spot
BYBIT_CATEGORY=linear

# Пара для торговли
SYMBOL=BTCUSDT

# Таймфреймы через запятую (минуты: 1,3,5,15,30,60,120,240,360,720 или D,W,M)
TIMEFRAMES=15,60,240
# Глубина стакана (bid/ask) для чтения в реальном времени; linear: 1–500
ORDERBOOK_LIMIT=25
# Order Flow (DOM, T&S, Delta, Sweeps): 1 = запускать стакан и поток сделок, результат в отчёте; 0 = выкл
ORDERFLOW_ENABLED=1
# Окно для T&S и Volume Delta (секунды)
ORDERFLOW_WINDOW_SEC=60
# Короткое окно «последний импульс» для context_now (сек); 0 = выкл
ORDERFLOW_SHORT_WINDOW_SEC=20
# При ORDERFLOW_ENABLED интервал опроса цикла (сек); быстрее = «здесь и сейчас»
POLL_INTERVAL_ORDERFLOW_SEC=15
# При SANDBOX_CONTEXT_NOW_ONLY (чисто проп-режим) — ещё чаще (сек)
POLL_INTERVAL_PROP_SEC=3
# WebSocket Bybit: ping_interval должен быть > ping_timeout (иначе «Ensure ping_interval > ping_timeout»)
ORDERFLOW_WS_PING_INTERVAL=30
ORDERFLOW_WS_PING_TIMEOUT=20
# 1 = писать метрики Order Flow в таблицу orderflow_metrics (та же БД); 0 = не писать
ORDERFLOW_SAVE_TO_DB=1
# 1 = песочница микроструктуры: виртуальная позиция и PnL по сигналу (нужен ORDERFLOW_ENABLED=1); 0 = выкл
MICROSTRUCTURE_SANDBOX_ENABLED=1
# Стартовый виртуальный баланс в USD для песочницы (например 100)
SANDBOX_INITIAL_BALANCE=100
# Комиссия биржи (taker), доля от объёма: 0.0006 = 0.06% (Bybit linear)
SANDBOX_TAKER_FEE=0.0006
# Мин. уверенность для входа (0..1): выше = меньше сделок, комиссия не съедает депозит
SANDBOX_MIN_CONFIDENCE=0.75
# Кулдаун (сек) после выхода до нового входа
SANDBOX_COOLDOWN_SEC=300
# Мин. время удержания позиции (сек) перед разрешением выхода по микроструктуре
SANDBOX_MIN_HOLD_SEC=120
# Тиков подряд с сигналом none/против — тогда закрыть; больше = меньше шума
SANDBOX_EXIT_NONE_TICKS=4
# Выход при уверенности ниже порога, 0 = не использовать (трейлинг по микроструктуре)
SANDBOX_EXIT_MIN_CONFIDENCE=0
# Минимум тиков «в нашу сторону» после входа перед разрешением выхода; 0 = выкл
SANDBOX_MIN_CONFIRMING_TICKS=0
# Окно выхода: последние M тиков; 0 = только N подряд
SANDBOX_EXIT_WINDOW_TICKS=0
# Сколько из последних M тиков должны быть «на выход» (при EXIT_WINDOW_TICKS > 0)
SANDBOX_EXIT_WINDOW_NEED=0
# Стоп-лосс в % от entry; 0 = выкл
SANDBOX_STOP_LOSS_PCT=0
# При прибыли >= этого % перенести SL в безубыток (0 = выкл; 0.15 = после +0.15% стоп на entry)
SANDBOX_BREAKEVEN_TRIGGER_PCT=0
# Тейк-профит в % от entry; 0 = выкл (используется, если SANDBOX_TP_LEVELS пуст)
SANDBOX_TAKE_PROFIT_PCT=0
# Частичный TP: "0.2:40,0.35:60" = на 0.2% закрыть 40%, на 0.35% — остаток; пусто = один TP по SANDBOX_TAKE_PROFIT_PCT
SANDBOX_TP_LEVELS=
# Трейлинг остатка: при прибыли >= trigger % включить трейлинг; закрыть при откате на trail % от пика (0 = выкл)
SANDBOX_TRAIL_TRIGGER_PCT=0
SANDBOX_TRAIL_PCT=0
# При выходе по микроструктуре в плюсе: не закрывать, пока профит < этого % (0 = выкл; 0.2 ≈ отбить комиссию)
SANDBOX_MIN_PROFIT_PCT=0.2
# 1 = не открывать позицию в тот же тик после закрытия (избежать мгновенного разворота)
SANDBOX_NO_OPEN_SAME_TICK_AS_CLOSE=1
# 1 = не открывать, когда сигнал даёт по сути только sweep (защита от ловушек)
SANDBOX_NO_OPEN_SWEEP_ONLY=1
# Секунд после последнего sweep до разрешения входа (0 = выкл)
SANDBOX_SWEEP_DELAY_SEC=20
# «Здесь и сейчас»: 1 = вход только при at_support+flow_bullish / at_resistance+flow_bearish; 0 = по сигналу микроструктуры
SANDBOX_USE_CONTEXT_NOW_PRIMARY=0
# 1 = направление только из context_now (без микроструктуры), чисто проп-режим
SANDBOX_CONTEXT_NOW_ONLY=0
# Цена в пределах этой доли от уровня = «у уровня» (0.0015 = 0.15%, 0.01 = 1%)
CONTEXT_NOW_LEVEL_DISTANCE_PCT=0.0015
# Порог delta_ratio в коротком окне для flow_bullish/flow_bearish
CONTEXT_NOW_DELTA_RATIO_MIN=0.12
# 1 = at_support/at_resistance по уровням стакана (DOM), 0 = по trading_zones (свечи)
CONTEXT_NOW_USE_DOM_LEVELS=0
# 1 = не открывать против тренда старшего ТФ (long только при не bearish, short при не bullish); в бэктесте тренд из свечей БД
SANDBOX_TREND_FILTER=1
# Плечо: мин/макс (1 = без плеча); 1 = адаптивное от уверенности и просадки
SANDBOX_LEVERAGE_MIN=1
SANDBOX_LEVERAGE_MAX=5
SANDBOX_ADAPTIVE_LEVERAGE=1
# Доля эквити под маржу (0.95 = 95%%); notional = margin * leverage
SANDBOX_MARGIN_FRACTION=0.95
# Ликвидация при убытке >= margin_used * это (1 = полная маржа)
SANDBOX_LIQUIDATION_MAINTENANCE=1
# При просадке от пика выше % — снижать макс. плечо вдвое
SANDBOX_DRAWDOWN_LEVERAGE_PCT=10
# Сигнал микроструктуры: мин. |score| для long/short (иначе none); выше = чаще нейтрально, меньше сделок
MICROSTRUCTURE_MIN_SCORE=0.35
# --- Опционально: ещё строже против комиссии (скопируй в .env при необходимости) ---
# SANDBOX_MIN_CONFIDENCE=0.55
# SANDBOX_COOLDOWN_SEC=180
# SANDBOX_MIN_PROFIT_PCT=0.25
# SANDBOX_EXIT_NONE_TICKS=5
# MICROSTRUCTURE_MIN_SCORE=0.4

# Минимальный score фазы (0..1). Подбор: python bin/backtest_phases.py --sweep-min-score / --tune. Рекомендуется 0.65–0.7 для лучшей точности по направлению.
PHASE_SCORE_MIN=0.65
# Ниже этого score фаза считается неясной (phase_unclear). Минимальный разрыв между основной и второй фазой (score_gap).
PHASE_UNCLEAR_THRESHOLD=0.5
PHASE_MIN_GAP=0.1
# Устойчивость фазы: доля последних тиков с той же фазой (0..1). Размер истории по ТФ (число тиков).
PHASE_STABILITY_MIN=0.6
PHASE_HISTORY_SIZE=5

# Тренд (модуль market_trend): минимальная сила (0..1), порог неясности, минимальный разрыв
TREND_STRENGTH_MIN=0.35
TREND_UNCLEAR_THRESHOLD=0.3
TREND_MIN_GAP=0.08
# В боковике (ADX < 20) чаще возвращать flat; мин. разрыв для «вниз» (0.10 = строже)
TREND_FLAT_WHEN_RANGE=1
TREND_MIN_GAP_DOWN=0
# Адаптация по ТФ (short/long): 1 = lookback, min_gap, min_gap_down по профилю; 0 = только из .env
TREND_USE_PROFILES=1
# Учёт режима рынка: 1 = в trend выше вес структуры/EMA, в range ниже; 0 = без учёта
TREND_REGIME_WEIGHTING=1
# В режиме surge: множитель bull/bear. 0 = выкл; 0.88 = чаще flat
TREND_SURGE_PENALTY=0
# Для «вверх» требовать подтверждение от +DI/-DI или структуры. 0 = нет (больше зон вверх на графике)
TREND_CONFIRM_UP=0
# Низкий объём: при volume_ratio < порога — множитель bull/bear. 0 = выкл
TREND_LOW_VOLUME_THRESHOLD=0.7
TREND_LOW_VOLUME_PENALTY=0
# Минимум согласований из трёх (структура, EMA, +DI/-DI) для up/down. 0 = не проверять (баланс зон как на графике)
TREND_MIN_AGREEMENT=0

# Торговые зоны: макс. уровней в выдаче. 0 = все найденные зоны, >0 = топ N по силе
TRADING_ZONES_MAX_LEVELS=0

# Фильтры входа: 0 = отключено. VOLUME_MIN_RATIO — мин. объём относительно MA(20). ATR_MAX_RATIO — макс. ATR/MA(ATR).
VOLUME_MIN_RATIO=0
ATR_MAX_RATIO=0
# Минимум ТФ, совпадающих по тренду и фазе с направлением входа (1 = только старший, 2+ = консенсус)
TF_ALIGN_MIN=1
# Устойчивость тренда: доля последних тиков с тем же направлением (0 = не проверять)
TREND_STABILITY_MIN=0
# Уровни: вход только если цена в пределах N (доля, 0.02 = 2%) от свинг-уровня. 0 = не проверять
LEVEL_MAX_DISTANCE_PCT=0
# Режим рынка (тренд/диапазон/всплеск): 1 = не входить при режиме «всплеск» по старшему ТФ
REGIME_BLOCK_SURGE=1
# Единый score входа (0..1): веса фазы, тренда и совпадения ТФ (сумма любая — нормализуется)
ENTRY_SCORE_WEIGHT_PHASE=0.4
ENTRY_SCORE_WEIGHT_TREND=0.35
ENTRY_SCORE_WEIGHT_TF_ALIGN=0.25
# Качество свечей: мин. quality_score (0..1) для использования ТФ; 0 = не проверять
CANDLE_QUALITY_MIN_SCORE=0

# Источник свечей для анализа: db — из БД (меньше запросов), exchange — каждый тик с биржи
DATA_SOURCE=db
# Минимальная уверенность сигнала (0..1) для фильтра «торговый» сигнал; 0 — не фильтровать
SIGNAL_MIN_CONFIDENCE=0
# Ретраи запросов к Bybit: макс попыток, задержка (с) при rate limit / сбое
EXCHANGE_MAX_RETRIES=5
EXCHANGE_RETRY_BACKOFF_SEC=1
EXCHANGE_REQUEST_TIMEOUT_SEC=30

# --- База для обучения (накопление свечей) ---
# Путь к SQLite (каталог создаётся сам)
DB_PATH=data/klines.db
# Все таймфреймы для БД: 1,3,5,15,30,60,120,240,360,720,D,W,M
TIMEFRAMES_DB=1,3,5,15,30,60,120,240,360,720,D,W,M
# Сколько свечей вглубь загружать при первом бэкфилле на каждый ТФ
BACKFILL_MAX_CANDLES=50000
# Как часто дотягивать новые свечи (секунды)
DB_UPDATE_INTERVAL_SEC=60
# При старте бота автоматически углублять историю по всем ТФ до упора (1=да, 0=нет)
AUTO_EXTEND_AT_STARTUP=1
# Каталог исторических данных (тики, стакан): пусто = data/history в корне проекта
HISTORY_DATA_DIR=

# --- Логирование ---
# Каталог логов (пусто = проект/logs). bot.log — всё, signals.log — компактные строки по каждому сигналу
LOG_DIR=
# Уровень: DEBUG, INFO, WARNING, ERROR. LOG_LEVEL_FILE — для файла (по умолчанию как LOG_LEVEL)
LOG_LEVEL=INFO
# Макс. размер одного файла (МБ), число старых файлов при ротации
LOG_FILE_MAX_MB=10
LOG_BACKUP_COUNT=7
# Писать ли отдельно signals.log (1/0)
LOG_SIGNALS_FILE=1

# --- Telegram (управление ботом) ---
# Токен от @BotFather
TELEGRAM_BOT_TOKEN=
# Разрешённые user id через запятую (пусто = все). Узнать id: /id в боте
TELEGRAM_ALLOWED_IDS=
# Алерт при смене сигнала: чат id для уведомлений (пусто = выкл), 1 = включить проверку
TELEGRAM_ALERT_CHAT_ID=
TELEGRAM_ALERT_ON_SIGNAL_CHANGE=0
# Интервал проверки (сек), мин. уверенность для алерта (0 = любая)
TELEGRAM_ALERT_INTERVAL_SEC=90
TELEGRAM_ALERT_MIN_CONFIDENCE=0
