# Итерации оптимизации песочницы

Документ для отслеживания гипотез и результатов итераций.

---

## Вариант 1: Включение защиты по цене (SL + TP + Breakeven)

**Гипотеза:** Gross PnL почти нулевой (-$5.01), но комиссия съедает всё. Нужно фиксировать прибыль через TP и ограничивать убытки через SL, чтобы не отдавать прибыль обратно и не накапливать большие минусы.

**Изменения в .env:**
```env
# Защита по цене
SANDBOX_STOP_LOSS_PCT=2.0          # Стоп-лосс 2% от входа
SANDBOX_BREAKEVEN_TRIGGER_PCT=0.5  # При прибыли 0.5% перенести SL в безубыток
SANDBOX_TAKE_PROFIT_PCT=1.5        # Тейк-профит 1.5% от входа
SANDBOX_TRAIL_TRIGGER_PCT=1.0      # При прибыли 1% включить трейлинг
SANDBOX_TRAIL_PCT=0.5              # Трейлинг: закрыть при откате 0.5% от пика

# Остальные параметры как в baseline
SANDBOX_MIN_CONFIDENCE=0.75
SANDBOX_COOLDOWN_SEC=300
SANDBOX_MIN_HOLD_SEC=120
SANDBOX_EXIT_NONE_TICKS=4
SANDBOX_MIN_PROFIT_PCT=0.2
MICROSTRUCTURE_MIN_SCORE=0.35
```

**Ожидаемый эффект:**
- Часть сделок будет закрываться по TP (фиксация прибыли) вместо microstructure
- Убытки ограничены SL (макс. -2% на сделку)
- После движения в прибыль SL переносится в безубыток
- Трейлинг защищает прибыль от откатов

**Запуск:**
```bash
# Быстрая проверка за 4 месяца:
python bin/backtest_sandbox.py --last-months 4 --force
python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2025
python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2026

# Полный период 2023–2025 (долго):
python bin/backtest_sandbox.py --from 2023-01-01 --to 2025-12-31 --force
python bin/sandbox_backtest_report.py --db --years 2023,2024,2025
```

**Статус:** бэктест завершён (2026-02-07). Итоги: 21 034 закрытия за 2025+2026, net -$89.80, win rate ~28.5%; почти все выходы по microstructure, SL/TP почти не сработали. Критерии не выполнены. Рекомендация: Вариант 2; при отсутствии улучшения — дальнейшие действия (Вариант 3 по желанию). См. SANDBOX_BACKTEST_RESULTS.md → Вариант 1, выводы.

---

## Вариант 2: Улучшение выхода по микроструктуре

**Гипотеза:** Если вариант 1 не даст достаточного улучшения, нужно реже выходить по микроструктуре в минусе — увеличить пороги подтверждения выхода.

**Изменения в .env:**
```env
# Более строгие пороги выхода по микроструктуре
SANDBOX_EXIT_NONE_TICKS=6          # Было 4 → больше тиков подряд для выхода
SANDBOX_MIN_HOLD_SEC=180            # Было 120 → дольше держим перед разрешением выхода
SANDBOX_MIN_PROFIT_PCT=0.3          # Было 0.2 → не закрывать в плюс раньше 0.3%
SANDBOX_EXIT_WINDOW_TICKS=10       # Окно подтверждения: последние 10 тиков
SANDBOX_EXIT_WINDOW_NEED=7         # Нужно 7 из 10 тиков «на выход»

# Защита по цене (из варианта 1, если он показал улучшение)
SANDBOX_STOP_LOSS_PCT=2.0
SANDBOX_BREAKEVEN_TRIGGER_PCT=0.5
SANDBOX_TAKE_PROFIT_PCT=1.5
SANDBOX_TRAIL_TRIGGER_PCT=1.0
SANDBOX_TRAIL_PCT=0.5
```

**Ожидаемый эффект:**
- Меньше ложных выходов по одному тику с сигналом none
- Больше времени на развитие прибыли перед выходом
- Окно подтверждения снижает шум

**Статус:** пресет создан `.env.presets/sandbox_variant2_exit.env`, в `.env` применён Вариант 2 с депозитом **$1000** (2026-02-07). Бэктест за 4 месяца нужно дозапустить вручную до конца (см. ниже).

**Запуск бэктеста (депозит $1000 уже в .env):**
```bash
python bin/backtest_sandbox.py --last-months 4 --force
python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2025
python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2026
```

**Результаты:** бэктест завершён. 19 447 закрытий за 2025+2026, net -$883.26, win rate ~31.5%; 99%+ выходов по microstructure, TP/breakeven единицы, SL/trailing 0. Критерии не выполнены. Рекомендация: Дальнейшие действия (см. критерии принятия решений и раздел ниже).

---

## Вариант 3: Ужесточение входа

**Гипотеза:** Если всё ещё много сделок с низким win rate, нужно реже входить — поднять пороги входа.

**Изменения в .env:**
```env
SANDBOX_MIN_CONFIDENCE=0.8          # Было 0.75 → выше порог уверенности
MICROSTRUCTURE_MIN_SCORE=0.4        # Было 0.35 → чаще none при слабых признаках
SANDBOX_COOLDOWN_SEC=600            # Было 300 → дольше пауза после выхода

# Параметры выхода и защиты из предыдущих вариантов (если показали улучшение)
```

**Ожидаемый эффект:**
- Меньше сделок → меньше комиссии
- Только самые сильные сигналы → выше качество входов

**Результаты:** *(заполнить после запуска)*

---

## Стратегия тестирования

Итеративный подход к бэктестированию: начинать с короткого периода (последний месяц) для быстрой проверки, при положительных результатах расширять диапазон с корректировкой параметров.

### Этапы тестирования

1. **Этап 1: Последний месяц** — быстрая проверка на свежих данных:
   ```bash
   python bin/backtest_sandbox.py --last-months 1 --force
   python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2025
   python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2026
   ```
   Если результаты положительные (net PnL > 0, win rate ≥ 55%) → перейти к этапу 2.

2. **Этап 2: Расширение до 2-3 месяцев** — проверка устойчивости на среднем периоде:
   ```bash
   python bin/backtest_sandbox.py --last-months 3 --force
   python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2025
   python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2026
   ```
   Если метрики остаются положительными → перейти к этапу 3. Если ухудшаются → вернуться к корректировке параметров на этапе 1.

3. **Этап 3: Дальнейшее расширение** — проверка на 4-6 месяцев, затем до года:
   ```bash
   python bin/backtest_sandbox.py --last-months 6 --force
   # или точный диапазон:
   python bin/backtest_sandbox.py --from 2025-01-01 --to 2025-12-31 --force
   ```
   При сохранении положительных результатов на каждом шаге расширения → перейти к этапу 4.

4. **Этап 4: Полный период** — финальная проверка на полном диапазоне (2023-2025):
   ```bash
   python bin/backtest_sandbox.py --from 2023-01-01 --to 2025-12-31 --force
   python bin/sandbox_backtest_report.py --db --years 2023,2024,2025
   ```
   Только после успешных результатов на меньших периодах. Если метрики ухудшаются — вернуться к корректировке параметров на предыдущем этапе.

### Корректировка при расширении

- При переходе на больший период проверять устойчивость результатов (не должно быть резкого ухудшения метрик).
- Если метрики ухудшаются на большем периоде — вернуться к корректировке параметров на меньшем периоде, где результаты были положительными.
- Только после стабильных положительных результатов (net PnL > 0, win rate ≥ 55%) на нескольких последовательных периодах переходить к следующему этапу.

**Принцип:** лучше потратить время на корректировку на коротком периоде, чем запускать долгий бэктест на полном диапазоне с параметрами, которые не работают.

---

## Порядок тестирования

1. **Вариант 1** (защита по цене) — приоритет, так как baseline показывает, что все выходы по microstructure без защиты.
2. Если вариант 1 не дал критериев → **Вариант 2** (жёстче выход по микроструктуре).
3. Если после Варианта 2 критерии по-прежнему не выполнены → **Дальнейшие действия** (раздел ниже). Вариант 3 (ужесточение входа) при желании можно проверить отдельно, но не как обязательный следующий шаг.

После каждого варианта сравнивать с baseline и предыдущими вариантами по:
- Net PnL (должен быть > 0)
- Win rate (должен быть ≥ 55%)
- Разбивке по exit_reason (должны появиться take_profit, stop_loss, trailing_stop)

---

## Критерии принятия решений: корректировать или менять подход?

После каждого варианта (особенно после Варианта 2) нужно решить: продолжать **корректировать** (тюнинг порогов) или **менять подход** (более глубокие изменения).

### Когда корректировать (тюнинг порогов)

- **Есть улучшение, но критерии не достигнуты:** win rate растёт (27% → 30% → 33%), net PnL улучшается (-$214 → -$90 → -$50), gross PnL положительный или близок к нулю. Направление верное, нужно донастроить пороги или уменьшить число сделок.
- **Структура выходов меняется:** появляются выходы по TP/SL/trailing (даже если их мало: 5–10% от общего), доля microstructure снижается (100% → 95% → 85%). Защита по цене работает, можно ужесточать пороги выхода или настраивать уровни SL/TP.
- **Качество сделок улучшается:** средний PnL на сделку растёт (-$0.03 → -$0.01 → $0.00), win rate растёт (даже медленно: 28% → 30% → 32%), максимальный убыток на сделку снижается (SL срабатывает). Качество входов/выходов улучшается, можно продолжать тюнинг.
- **Gross PnL положительный, но комиссия съедает:** gross PnL > 0, но net < 0 из-за комиссии, комиссия > |gross PnL|. Проблема в количестве сделок, а не в качестве. Тюнинг входа (меньше сделок) или выхода (лучше фиксировать прибыль) имеет смысл.

### Когда менять подход (не тюнинг)

- **Метрики "плоские" между вариантами:** win rate не меняется (28% → 28% → 28%), net PnL в том же диапазоне (-$90 → -$95 → -$85), структура выходов не меняется (всё ещё 95%+ microstructure). Тюнинг порогов не меняет качество результата, только объём. Нужна смена логики.
- **Структура выходов не меняется:** после Варианта 1 (SL/TP включены) всё ещё 95%+ выходов по microstructure, SL/TP/trailing почти не срабатывают (0–2% сделок), даже при жёстких порогах выхода (Вариант 2) структура та же. Сигнал микроструктуры "выход" срабатывает раньше, чем цена доходит до SL/TP. Проблема в сигнале или контексте, а не в порогах.
- **Gross PnL стабильно отрицательный:** gross PnL < 0 (не только из-за комиссии), средний PnL на сделку < 0 даже без комиссии, win rate стабильно низкий (25–35%) и не растёт. Проблема в направлении/качестве сигналов, а не в порогах. Нужна смена сигнала/контекста/условий запуска.
- **Резкое падение числа сделок без улучшения:** после ужесточения входа сделок стало в 2–3 раза меньше, но net PnL не улучшился (или ухудшился), средний PnL на сделку остался ≤ 0. Пороги входа не отделяют "хорошие" сигналы от "плохих". Нужна смена логики входа (context_now, тренд, фаза).

### Практическое правило

После Варианта 2 проверьте:

- **Если есть улучшение** (win rate +2–3%, net PnL лучше на 20–30%) **и структура выходов меняется** (TP/SL появляются) → можно продолжать тюнинг (Вариант 3 или точечные правки).
- **Если метрики "плоские"** (win rate ±1%, net PnL в том же диапазоне) **и структура не меняется** (всё ещё 95%+ microstructure) → переходить к "Дальнейшим действиям" (сигнал, контекст, режимы рынка).

**Итог:** если тюнинг даёт улучшение и меняет структуру — продолжайте. Если метрики стагнируют и структура не меняется — меняйте подход.

---

## Дальнейшие действия (если Вариант 2 не дал результата)

Если после Варианта 2 критерии приёмки (net PnL > 0, win rate ≥ 55%) по-прежнему не выполнены, перейти к более глубоким изменениям. Ниже — порядок шагов и как каждый проверить.

### 1. Сигнал и контекст

- **Режимы context_now:** включить в .env `SANDBOX_USE_CONTEXT_NOW_PRIMARY=1` или `SANDBOX_CONTEXT_NOW_ONLY=1`, оставив защиту по цене (SL/TP). Вход тогда привязан к уровням и потоку (at_support + flow_bullish / at_resistance + flow_bearish), а не только к сигналу микроструктуры.
- **Пресет и бэктест:** создан `.env.presets/sandbox_further_context_now.env` (USE_CONTEXT_NOW_PRIMARY=1, остальное как Вариант 2). В бэктесте передаётся синтетический context_now из дельты (allowed_long при delta_ratio > 0.15, allowed_short при delta_ratio < -0.15). В .env уже применён этот пресет.
- **Как проверить:** дозапустить бэктест за 1 месяц до конца: `python bin/backtest_sandbox.py --last-months 1 --force`, затем `python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2026`. Сравнить число сделок, win rate и разбивку по exit_reason с Вариантом 2.

**Результат п.1 (context_now primary):** полный прогон за **2026-01-07 — 2026-02-07** (1 месяц тиков): 3 276 закрытий, win rate **33.5%**, gross PnL **+$30.64**, комиссия **$1 085.90** (open+close), net PnL **-$1 055.26**, эквити на конец -$55.26. Выходы: microstructure 3 268, take_profit 5, breakeven 3. Критерии (net > 0, win rate ≥ 55%) не достигнуты. Комиссия съедает весь gross. **Следующий шаг:** п.2 (условия запуска, фильтр по тренду/фазе) или снижение числа сделок/объёма; при желании — расширить период (`--last-months 3`) для проверки устойчивости.

- **Дальше при необходимости:** изменить пороги/окна в `compute_microstructure_signal` или в orderflow (дельта, imbalance, окна) и снова гонять бэктест за 1 месяц.

### 2. Условия запуска песочницы

- **Фильтр по тренду/фазе:** не открывать позицию, если старший ТФ в определённой фазе (например, только не bearish для long, не bullish для short — уже есть SANDBOX_TREND_FILTER). При необходимости ужесточить: разрешать вход только при явном тренде в нашу сторону (отдельный порог или фаза рынка).
- **Как проверить:** добавить в код песочницы или в вызов обновление условия входа (например, по данным из `market_phases` или `detect_trend`). Бэктест за 1 месяц, сравнение с текущим Вариантом 2.

### 3. Роль песочницы

- **Не в прод как единственный драйвер:** зафиксировать, что песочница используется для анализа и обучения; решение о сделках в прод принимается по другим правилам (тренд, уровни, фаза).
- **Комбинированная логика:** в лайве вход только при совпадении сигнала песочницы и тренда/уровня (песочница как фильтр, а не единственный источник).
- **Как проверить:** не требует бэктеста — решение по архитектуре и конфигу (когда включать песочницу в лайве, как комбинировать с другими сигналами).

### 4. Качество бэктеста и данных

- **Комиссия и проскальзывание:** убедиться, что SANDBOX_TAKER_FEE соответствует бирже; при необходимости заложить проскальзывание в расчёт PnL (сейчас может не учитываться).
- **Устойчивость по периодам:** гонять бэктест по разным годам/месяцам и смотреть, не тянет ли один период все метрики вниз; при необходимости исключить аномальный период из критериев или разобрать его отдельно.
- **Как проверить:** сравнение отчётов по годам; при наличии кода проскальзывания — повторный прогон и сравнение net PnL.

### 5. Пересмотр алгоритма

Когда тюнинг (Варианты 1–2), context_now (п.1) и фильтры (п.2) не выводят в зону критериев, имеет смысл **пересмотреть саму логику сигнала и решений**, а не только пороги и условия запуска.

**Что пересмотреть (по приоритету):**

1. **Формирование сигнала микроструктуры** (`src/analysis/microstructure_signal.py`, `compute_microstructure_signal`):
   - Вклады delta / imbalance / sweep в итоговый score: веса, пороги (delta_ratio_min, imbalance_eps, sweep_weight), затухание sweep по времени.
   - Обработка конфликта компонентов (conflict_penalty): не подавляет ли она хорошие входы или, наоборот, пропускает шум.
   - Условие «sweep_only» (min_delta_imbalance_contrib_for_confirm): не входим ли мы часто по одному sweep без подтверждения дельтой/imbalance.
   - Пороги направления (min_score_for_direction, min_score_long/short) и формула confidence: насколько они отделяют «хорошие» моменты от шума.

2. **Вход и контекст** (`MicrostructureSandbox`, context_now):
   - Когда разрешаем long/short: только по сигналу микроструктуры или только при совпадении с context_now (уровни + поток). Нужно ли жёстче требовать совпадение нескольких факторов.
   - Синтетический context_now в бэктесте (delta_ratio > 0.15 / < -0.15): насколько он адекватен реальным «уровням + поток»; не слишком ли часто он разрешает вход.

3. **Выход по микроструктуре** (`exit_none_ticks`, окно выхода):
   - Почему почти все выходы по microstructure: сигнал «none» или «против» срабатывает очень часто. Пересмотреть: что именно даёт смену направления (дельта, imbalance, sweep), не выходим ли мы по шуму (короткие окна, малые пороги).
   - Имеет ли смысл другой критерий выхода: не «N тиков подряд none», а, например, смена контекста (дельта перешла в противоположную зону) или подтверждение объёмом.

4. **Входы в orderflow** (`analyze_orderflow`, окна, агрегация):
   - Размеры окон (ORDERFLOW_WINDOW_SEC, short window): не слишком ли короткие/длинные для тикового реплея и для реального лайва.
   - Агрегация тиков по времени vs по количеству: в бэктесте тик каждые N секунд — как это соотносится с тем, как мы интерпретируем дельту и T&S.

**Как проверить после изменений:** бэктест за 1 месяц (`--last-months 1 --force`), отчёт по сделкам и разбивке по exit_reason; сравнить число сделок, win rate, gross и net PnL с текущим прогоном (2026-01-07 — 2026-02-07). При улучшении — расширить период.

**Итерация 1 (пресет algorithm_rev1):** уже внедрено. Параметры формулы сигнала вынесены в конфиг; при значениях 0 или отрицательных используются дефолты в коде.

**Изменения в логике алгоритма (код, не только пороги):**
- **Конфликт → не входить:** если компоненты (delta, imbalance, sweep, тренд) противоречат друг другу по знаку, принудительно `direction = "none"` (вход запрещён). Включается по умолчанию (`MICROSTRUCTURE_CONFLICT_MEANS_NONE=True`).
- **Минимум N согласных:** для long нужно не менее `require_agreement_min` компонентов (delta, imbalance, sweep) с положительным вкладом выше порога; для short — с отрицательным. По умолчанию 2 (`MICROSTRUCTURE_REQUIRE_AGREEMENT_MIN=-1` в конфиге = код использует 2; 0 = отключить проверку).

- **Конфиг:** `MICROSTRUCTURE_DELTA_RATIO_MIN`, `MICROSTRUCTURE_SWEEP_WEIGHT`, `MICROSTRUCTURE_CONFLICT_PENALTY`, `MICROSTRUCTURE_MIN_DELTA_IMBALANCE_CONFIRM`, `MICROSTRUCTURE_IMBALANCE_EPS`. Пресет `.env.presets/sandbox_algorithm_rev1.env`: MIN_SCORE=0.4, DELTA_RATIO_MIN=0.2, SWEEP_WEIGHT=0.2, CONFLICT_PENALTY=0.35, MIN_DELTA_IMBALANCE_CONFIRM=0.1.
- **Ожидание:** меньше входов (строже порог дельты и подтверждение, меньше вес sweep, сильнее штраф за конфликт) → меньше комиссии; при сохранении или росте win rate — улучшение net PnL.
- **Запуск:** скопировать пресет в `.env` или подставить переменные, затем `python bin/backtest_sandbox.py --last-months 1 --force`, `python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2026`. Сравнить с прогоном 2026-01-07 — 2026-02-07 (3276 закрытий, WR 33.5%, net -$1055).

**Рекомендуемый порядок:** если п.2 (условия запуска) и снижение сделок не дают сдвига — заложить итерацию **пересмотра алгоритма** (п.5): начать с п.5.1 (формула сигнала и веса), затем при необходимости п.5.2–5.4.

---

**Рекомендуемый порядок:** сначала п.1 (context_now), затем при необходимости п.2 (условия запуска). При «плоских» метриках — п.5 (пересмотр алгоритма). П.3 и п.4 — параллельно или по мере необходимости.
