# Оптимизация и функционал: что можно добавить

## 1. Оптимизация

### 1.1. Скорость расчёта (multi_tf)

| Что | Зачем | Сложность |
|-----|--------|-----------|
| **Параллельный расчёт по ТФ** | Тренд, фаза, режим, импульс по каждому ТФ не зависят друг от друга — считаются по разным свечам. Запуск в `ThreadPoolExecutor` (или `ProcessPoolExecutor` при тяжёлых циклах) сократит время одного тика при 3+ ТФ. | Средняя |
| **Меньше вызовов detect_trading_zones для confluence** | Сейчас зоны считаются для старшего ТФ и отдельно для каждого другого ТФ (для confluence). Можно ограничиться одним «средним» ТФ (например, только 60) для confluence — один лишний вызов вместо двух. | Низкая |
| **Не таскать candles в отчёте** | В `timeframes_report[tf]` хранятся полные `candles` (200 свечей × 3 ТФ). Для лога и Telegram достаточно метаданных; полный список нужен только внутри multi_tf. Вариант: в возвращаемом report класть `candles_count` и не отдавать `candles` наружу (или отдавать только по флагу). Снижает объём данных и сериализацию. | Низкая |
| **Кэш свечей на один тик** | При `DATA_SOURCE=db` за один тик данные по ТФ не меняются. Можно не перечитывать из БД повторно внутри того же вызова `analyze_multi_timeframe` (уже так: один _load_candles_from_db). Для bot_loop между тиками данные обновляются по таймеру — кэш на 1 тик не нужен. Опционально: короткий TTL-кэш (10–30 с) для аналитики, если один и тот же отчёт запрашивают часто (например, /signal несколько раз подряд). | Низкая |

### 1.2. База данных

| Что | Зачем | Сложность |
|-----|--------|-----------|
| **Индексы** | Уже есть `ix_klines_symbol_tf_time`. При выборках по `(symbol, timeframe)` и сортировке по `start_time` этого обычно достаточно. При появлении тяжёлых запросов по диапазону дат — составной индекс под запрос. | Низкая |
| **PRAGMA** | WAL уже включён. Для только чтения в части процессов можно `PRAGMA query_only=1`; для ускорения записей в одном процессе — `PRAGMA synchronous=NORMAL` (риск при сбое питания). | Низкая |
| **Кэш get_candles_last_days** | Уже есть (TTL 60 с). При необходимости увеличить TTL для тяжёлых отчётов (например, /chart). | Низкая |

### 1.3. Логирование и конфиг

| Что | Зачем | Сложность |
|-----|--------|-----------|
| **Уровни лога** | Детальный разбор по каждому ТФ оставлять в `logger.debug`, в INFO — только сводку (сигнал, старший ТФ, зоны, импульс). Меньше шума и I/O. | Низкая |
| **Конфиг** | Уже загружается один раз (pydantic-settings). Менять не требуется. | — |

---

## 2. Функционал

### 2.1. Валидация и аналитика

| Что | Зачем | Сложность |
|-----|--------|-----------|
| **Replay-бэктест по сигналам** | По историческим свечам из БД скользящее окно: на каждом баре вызывать `analyze_multi_timeframe` (по срезу до этого бара), записывать direction и confidence. Потом считать виртуальный PnL при правиле «вход по direction, выход через N баров или по противоположному сигналу». Без исполнения — проверка, даёт ли логика преимущество на истории. | Средняя |
| **Экспорт сигналов в CSV** | Каждый тик дописывать строку: время, symbol, direction, confidence, phase, trend, momentum, zone_low, zone_high. Удобно для разбора в Excel/Python и для дообучения порогов. | Низкая |
| **Health-проверка** | Команда или эндпоинт: свежесть БД по каждому ТФ (последняя свеча), время последнего сигнала, при необходимости — пинг Bybit API. Для мониторинга и алертов «данные устарели». | Низкая |

### 2.2. Telegram и алерты

| Что | Зачем | Сложность |
|-----|--------|-----------|
| **Команды /zones, /momentum** | Отдельно вывести зоны (уровни, confluence, перевороты) и импульс (state, direction, RSI) без полного /signal. Быстрый срез. | Низкая |
| **Алерт при смене сигнала** | При смене direction (например, none → long или long → short) отправлять в Telegram короткое сообщение. Опционально: только при confidence выше порога. | Низкая |
| **Кнопка «Сигнал» / «Зоны» / «Импульс»** | Разные ответы по кнопкам (сводка сигнала, только зоны, только импульс) без лишнего текста. | Низкая |

### 2.3. Мульти-символ и гибкость

| Что | Зачем | Сложность |
|-----|--------|-----------|
| **Несколько символов** | В конфиге `SYMBOLS=BTCUSDT,ETHUSDT`. В цикле по каждому символу вызывать анализ (те же модули, другой symbol). Лог/Telegram — по каждому символу или сводка. Нужно для мульти-пар без дублирования кода. | Средняя |
| **Пороги из конфига** | Уже есть (PHASE_*, TREND_*, LEVEL_*, ENTRY_*). При необходимости вынести в .env оставшиеся магические числа (например, confluence threshold 0.002, volume_confirm_ratio 0.5). | Низкая |

### 2.4. Визуализация и отчёты

| Что | Зачем | Сложность |
|-----|--------|-----------|
| **График зон на свечах** | На существующий свечной график (backtest_chart /chart) нанести уровни из trading_zones (zone_low/zone_high, перевороты). Один статичный PNG для Telegram или файл. | Средняя |
| **Ежедневный/еженедельный отчёт** | Раз в день/неделю формировать сводку: число сигналов, распределение direction, средний confidence, последние перевороты зон. В лог или в Telegram. | Низкая |

---

## 3. Приоритеты

| Приоритет | Оптимизация / Функционал | Эффект |
|-----------|---------------------------|--------|
| 1 | Параллельный расчёт по ТФ в multi_tf | Быстрее тик при 3+ ТФ |
| 2 | Replay-бэктест по сигналам (без исполнения) | Понимание, работает ли логика на истории |
| 3 | Экспорт сигналов в CSV | Анализ и настройка порогов |
| 4 | /zones, /momentum в Telegram, алерт при смене сигнала | Удобство и контроль |
| 5 | Не таскать candles в отчёте (или по флагу) | Меньше памяти и трафика |
| 6 | Confluence только по одному среднему ТФ | Меньше вызовов detect_trading_zones |
| 7 | Health-проверка, график зон на свечах | Мониторинг и наглядность |
| 8 | Несколько символов | Мульти-пара без дублирования |

---

## 4. Кратко

- **Оптимизация:** параллель по ТФ, меньше данных в отчёте, точечно кэш и PRAGMA, логи по уровням.
- **Функционал:** replay-бэктест по сигналам, экспорт в CSV, /zones и /momentum, алерт при смене направления, мульти-символ, health, график зон.

Сначала имеет смысл внедрить параллель по ТФ и replay-бэктест по сигналам — они сильнее всего влияют на скорость и на понимание качества системы.
