# Почему PnL скромный и как улучшить

## Возможные причины

### 1. Фиксированные TP/SL режут прибыль и усиливают убытки

- **TP 5%** на дневном ТФ по BTC часто срабатывает раньше, чем тренд заканчивается — прибыль ограничивается.
- **SL 1.5–2%** на волатильном активе легко выбивает по шуму, после чего цена может развернуться в нужную сторону.
- Итог: много выходов по TP/SL вместо выхода по сигналу стратегии.

**Что делать:**  
Сравнивать режим «только по сигналу» (без TP/SL) с текущим — через движок `src/utils/backtest_engine.py` и свою сигнальную функцию.

### 2. Оптимизация только по одному году (переобучение)

- Сетка TP/SL/lookback подбирается по **2025 году целиком** — параметры заточены под этот период.
- На другом периоде или другом активе результат может сильно просесть.

**Что делать:**  
Разделять выборку на train и OOS и смотреть результат на OOS — при добавлении своих стратегий и скриптов оптимизации учитывать переобучение.

### 3. Узкая сетка оптимизации

- Сейчас: TP 3–6%, SL 1.5–2.5%, lookback 80–120.
- Для дневного ТФ по криптоактиву тренды часто больше 5–10% — текущий TP может быть мал.

**Что делать:**  
При добавлении своих стратегий и скриптов оптимизации — пробовать более широкие TP и SL в сетке поиска.

### 4. Логика стратегий (лаг и фильтры)

- Фазы/тренды считаются по **прошлым** барам (окно до текущего) — вход и выход с лагом.
- Жёсткие фильтры (фаза + зона, полный комбо) дают мало сделок; часть из них может быть убыточной.

**Что делать:**  
- Пробовать стратегии с меньшим числом условий.
- При необходимости уменьшить `lookback` (например, 60–80) для более быстрой реакции (но растёт шум).

### 5. Только лонг, один актив, один год

- Нет шортов — в медвежьих участках года стратегии не зарабатывают.
- Один актив (BTC) и один год — малая выборка, выводы неуниверсальны.

**Что делать:**  
- Добавить шорты (отдельная доработка движка и стратегий).
- Гонять бэктест по нескольким годам и, при наличии, по нескольким парам.

---

## Рекомендуемый порядок проверки

1. **Сравнить с выходом только по сигналу** — если PnL вырастет без TP/SL, проблема скорее в TP/SL.
2. **Расширить сетку TP/SL** при своей оптимизации — подобрать более широкие TP (и при необходимости SL).
3. **Проверить переобучение** — смотреть OOS; при сильном проседании ужесточать критерии или брать консервативные параметры.
4. **Дальше** — ATR-based TP/SL (`src/utils/tp_sl.py`), трейлинг-стоп, шорты, несколько лет/пар — по мере необходимости.
