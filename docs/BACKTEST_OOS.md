# Бэктест vs форвард: как не переоценить результат

## Проблема

**На бэктесте метрики часто лучше, чем на форварде (реальная торговля или отложенный тест).** Причины:

1. **Переобучение (overfitting):** Подбор порогов (`--tune`, `--sweep-min-score`) делается по тем же данным, по которым считается точность. Мы невольно выбираем параметры, которые «подогнаны» под эту историю — на новых данных они работают хуже.
2. **Data snooping:** Многократный перебор и просмотр отчётов по одной и той же выборке ведёт к косвенному подгону под прошлое.
3. **Смена режима рынка:** Поведение цены со временем меняется; то, что работало на старых данных, может не работать на новых.
4. **Упрощения бэктеста:** Идеальное исполнение, без проскальзывания и задержек — в реале результат хуже.

Итог: **in-sample** (то, что мы меряем на всей истории или на части, по которой подбирали) даёт оптимистичную оценку; **out-of-sample (OOS)** — на данных, которые не использовались при подборе — ближе к форварду.

---

## Подход: разделение train / out-of-sample

1. **Хронологический сплит:** Вся история делится на две части по времени:
   - **Train (обучение/калибровка):** более старая часть (например, первые 70% по времени).
   - **Test (OOS, отложенная выборка):** более новая часть (последние 30%) — имитация «будущего».

2. **Правила:**
   - При **подборе порогов (`--tune`)** перебор делается **только по train**. Лучшая комбинация выбирается по точности на train.
   - **Итоговую метрику** всегда смотрим **на OOS (test)** — она и есть оценка «как будет на форварде».
   - По желанию выводим и in-sample (train), и OOS (test), чтобы видеть разрыв (если OOS сильно ниже — признак переобучения).

3. **Параметры в скриптах:**
   - `--train-ratio 0.7` — 70% данных (по времени, старые) = train, 30% (новые) = OOS.
   - `--oos-bars 5000` — ровно последние 5000 баров = OOS, остальное = train.
   - Если ни один не задан — работаем по всей выборке как раньше (один блок, без OOS).

Так мы **нивелируем завышение**: подбор только по train, а «честная» оценка — по OOS.

---

## Что реализовано

- **backtest_phases:** опции `--train-ratio` и `--oos-bars`; при сплите выводится точность **In-sample (train)** и **Out-of-sample (test)**. При `--tune` подбор только по train, финальная точность лучшей комбинации — по OOS.
- **backtest_trend:** те же опции и логика.

Рекомендация: при подборе порогов всегда задавать сплит (например `--train-ratio 0.7`) и ориентироваться на метрику **Out-of-sample**.
