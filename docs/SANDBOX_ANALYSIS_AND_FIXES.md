# Анализ песочницы микроструктуры и предложения по улучшению

## Результаты по sandbox_trades.csv (72 сделки, ~1.5 часа)

### Сводка

| Метрика | Значение |
|--------|----------|
| **Всего записей** | 72 (36 входов + 36 выходов, последняя позиция long открыта) |
| **Реализованный PnL (gross)** | ~+0.38 USD |
| **Комиссия** | ~4.32 USD (72 × 0.06) |
| **PnL с учётом комиссии** | **~−3.94 USD** |
| **В плюс** | 19 закрытий |
| **В минус** | 16 закрытий |
| **Win rate** | 54% |

### Вывод

Сигнал по микроструктуре даёт **положительный gross PnL**, но из-за **очень частой торговли** комиссия съедает весь результат. Нужно сократить число сделок без потери качества входов.

### Причины избыточной торговли

1. **Низкий порог входа** — сейчас `min_confidence_to_open = 0`, входят при 0.3 (только «imbalance bid/ask»).
2. **Мгновенный разворот** — при смене сигнала long↔short сразу закрываем и открываем в другую сторону, без паузы.
3. **Слабый порог «none»** — `min_score_for_direction = 0.25`, много пограничных сигналов дают направление вместо «нейтрально».

---

## Предложения (реализованы в коде)

### 1. Порог уверенности для входа (SANDBOX_MIN_CONFIDENCE)

- В конфиг добавлен **SANDBOX_MIN_CONFIDENCE** (по умолчанию **0.4**).
- Вход только при `confidence >= SANDBOX_MIN_CONFIDENCE`. Отсекаются входы на 0.3 («imbalance bid» и т.п.).

### 2. Кулдаун после выхода (SANDBOX_COOLDOWN_SEC)

- В конфиг добавлен **SANDBOX_COOLDOWN_SEC** (по умолчанию **60** секунд).
- После закрытия позиции новый вход разрешён только через N секунд. Снижает «пинг-понг» long/short.

### 3. Жёстче нейтральная зона в сигнале (опционально)

- Увеличить **min_score_for_direction** в `microstructure_signal` (через конфиг **MICROSTRUCTURE_MIN_SCORE**, по умолчанию 0.3).
- Чаще возвращается `none` → меньше лишних входов и разворотов.

---

## Рекомендуемые значения в .env

```env
# Песочница: меньше сделок → комиссия не съедает gross PnL
SANDBOX_MIN_CONFIDENCE=0.45
SANDBOX_COOLDOWN_SEC=90
# Сигнал: чаще «нейтрально» при слабых признаках
MICROSTRUCTURE_MIN_SCORE=0.3
```

После применения перезапустить бота и снять новый лог сделок для сравнения.

---

## Критерии готовности к проду

Песочница считается готовой к запуску в прод, если выполнены следующие критерии (по результатам бэктеста за период 2023–2025):

### Основные критерии

1. **Чистый PnL (после комиссии) > 0** за весь период бэктеста (2023–2025).
2. **Win rate ≥ 55%** при числе закрытий не менее 50 (чтобы исключить случайность на малой выборке).
3. **Чистый PnL положительный хотя бы по двум из трёх лет** (2023, 2024, 2025) — устойчивость к разным рыночным условиям.

### Дополнительные критерии (опционально)

- Максимальная просадка от пика эквити не превышает 20% (защита от больших убытков).
- Разбивка по exit_reason показывает, что основная часть прибыли приходит от take_profit / trailing_stop, а не только от microstructure (защита по цене работает).

### Процесс проверки

1. Запустить полный бэктест: `python bin/backtest_sandbox.py --from 2023-01-01 --to 2025-12-31 --force`
2. Снять отчёт: `python bin/sandbox_backtest_report.py --db --years 2023,2024,2025`
3. Проверить выполнение критериев по метрикам из отчёта.
4. При выполнении — зафиксировать набор параметров (.env) как прод-пресет.

**Текущий статус:** критерии не выполнены, идёт итеративная оптимизация параметров входа/выхода и протягивания сделки.
