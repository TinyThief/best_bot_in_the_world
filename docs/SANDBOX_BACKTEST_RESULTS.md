# Результаты бэктеста песочницы микроструктуры

Документ для сравнения вариантов настроек по результатам бэктеста за период 2023–2025.

---

## Baseline (текущие настройки)

**Дата:** 2026-02-06  
**Run ID:** `backtest_BTCUSDT_2023-01-01_2025-12-31_1770386737`  
**Параметры:** 
- SANDBOX_MIN_CONFIDENCE=0.75
- SANDBOX_COOLDOWN_SEC=300
- SANDBOX_MIN_HOLD_SEC=120
- SANDBOX_EXIT_NONE_TICKS=4
- SANDBOX_STOP_LOSS_PCT=0 (выключен)
- SANDBOX_TAKE_PROFIT_PCT=0 (выключен)
- SANDBOX_MIN_PROFIT_PCT=0.2
- MICROSTRUCTURE_MIN_SCORE=0.35
- SANDBOX_TREND_FILTER=1

### Метрики по годам

| Год | Закрытий | Gross PnL | Комиссия | Net PnL |
|-----|----------|-----------|----------|---------|
| 2023 | 172 | -$5.26 | $230.17 | -$235.43 |
| 2024 | 0 | $0.00 | $0.00 | $0.00 |
| 2025 | 0 | $0.00 | $0.00 | $0.00 |
| **Итого** | **150** | **-$5.01** | **$209.26** | **-$214.26** |

*Примечание: по run_id — 150 закрытий; по годам — 172 за 2023 (возможно, разные фильтры или данные).*

### Разбивка по exit_reason

| Причина выхода | Сделок | PnL (сумма) |
|----------------|--------|-------------|
| microstructure | 150 | -$5.01 |
| stop_loss | 0 | $0.00 |
| take_profit | 0 | $0.00 |
| take_profit_part | 0 | $0.00 |
| trailing_stop | 0 | $0.00 |
| breakeven | 0 | $0.00 |
| liquidation | 0 | $0.00 |

### Дополнительные метрики

- **Win rate:** 27.3% (41 из 150 закрытий в плюс)
- **Средний PnL на сделку:** -$0.03 USD
- **Максимальная просадка:** *(не рассчитано)*

### Выводы

**Критерии приёмки НЕ выполнены:**
- ❌ Net PnL = -$214.26 (требуется > 0)
- ❌ Win rate = 27.3% (требуется ≥ 55%)
- ❌ Все выходы по причине "microstructure" — защита по цене (SL/TP) не используется

**Проблемы:**
1. Gross PnL отрицательный (-$5.01), но основная проблема — комиссия ($209.26) съедает весь результат.
2. Низкий win rate (27.3%) — большинство сделок закрывается в минус.
3. Нет защиты по цене — все выходы только по сигналу микроструктуры, нет фиксации прибыли через TP и ограничения убытков через SL.

**Направления улучшения:**
1. Включить защиту по цене: SL, TP, breakeven, trailing stop.
2. Улучшить логику выхода по микроструктуре: увеличить EXIT_NONE_TICKS, MIN_HOLD_SEC, MIN_PROFIT_PCT.
3. Возможно, ужесточить вход: поднять MIN_CONFIDENCE или MICROSTRUCTURE_MIN_SCORE.

---

## Вариант 1: Защита по цене (SL + TP + Breakeven + Trailing)

**Дата применения пресета:** 2026-02-07  
**Пресет:** `.env.presets/sandbox_variant1_sl_tp.env`, параметры внесены в `.env`.  
**Изменения в .env:**
- SANDBOX_STOP_LOSS_PCT=2.0
- SANDBOX_BREAKEVEN_TRIGGER_PCT=0.5
- SANDBOX_TAKE_PROFIT_PCT=1.5
- SANDBOX_TP_LEVELS= (пусто)
- SANDBOX_TRAIL_TRIGGER_PCT=1.0
- SANDBOX_TRAIL_PCT=0.5
- Остальное как в baseline (MIN_CONFIDENCE=0.75, COOLDOWN=300, MIN_HOLD_SEC=120, EXIT_NONE_TICKS=4, MIN_PROFIT_PCT=0.2, MICROSTRUCTURE_MIN_SCORE=0.35)
- SANDBOX_CONTEXT_NOW_ONLY=0 (режим по сигналу микроструктуры)

### Метрики по годам (прогон за ~4 месяца: 2025 + начало 2026)

Источник: `logs/sandbox_trades.csv` после завершения бэктеста (2026-02-07).

| Год | Закрытий | Gross PnL | Комиссия | Net PnL | Win rate |
|-----|----------|-----------|----------|---------|----------|
| 2023 | 0 | $0.00 | $0.00 | $0.00 | — |
| 2024 | 0 | $0.00 | $0.00 | $0.00 | — |
| 2025 | 20 364 | -$2.43 | $87.32 | -$89.76 | 28.2% |
| 2026 | 670 | $1.17 | $1.21 | -$0.04 | 37.9% |
| **Итого** | **21 034** | **-$1.26** | **$88.53** | **-$89.80** | **~28.5%** |

### Разбивка по exit_reason

| Причина выхода | 2025 (сделок / PnL) | 2026 (сделок / PnL) |
|----------------|---------------------|----------------------|
| microstructure | 20 355 / -$3.81 | 666 / $0.46 |
| take_profit | 4 / $1.43 | 4 / $0.70 |
| breakeven | 5 / -$0.05 | 0 / $0.00 |
| stop_loss | 0 | 0 |
| trailing_stop | 0 | 0 |

Почти все выходы по микроструктуре; SL и trailing_stop не сработали.

### Как снять итоговые метрики

После прогона:
```bash
python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2025
python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2026
```
Или из БД: `python bin/sandbox_backtest_report.py --db --years 2023,2024,2025` (если бэктест писал в БД с run_id).

### Сравнение с baseline

- **Baseline:** 150 закрытий (по run_id), net -$214.26, win rate 27.3%, все выходы по microstructure.
- **Вариант 1:** 21 034 закрытия за 2025+2026, net -$89.80, win rate ~28.5%. Gross почти нулевой (-$1.26), комиссия $88.53. TP и breakeven сработали единично; SL и trailing не сработали.

Убыток на сделку меньше (меньше комиссии в абсолютных цифрах при большем числе сделок — другой период/объём), но критерии не достигнуты.

### Выводы

**Критерии приёмки НЕ выполнены:**
- ❌ Net PnL = -$89.80 (требуется > 0)
- ❌ Win rate ≈ 28.5% (требуется ≥ 55%)

**Наблюдения:**
1. Защита по цене почти не задействована: 99%+ выходов по microstructure, TP — 8 сделок, breakeven — 5, SL и trailing — 0.
2. Gross PnL близок к нулю (-$1.26), основная доля потерь — комиссия ($88.53).
3. Логика выхода по микроструктуре доминирует; SL/TP не успевают срабатывать (либо пороги далеко от типичного движения).

**Рекомендация:** перейти к **Варианту 2** (жёстче выход по микроструктуре: EXIT_NONE_TICKS, MIN_HOLD_SEC, MIN_PROFIT_PCT, окно подтверждения) и/или **Варианту 3** (ужесточение входа: MIN_CONFIDENCE, MICROSTRUCTURE_MIN_SCORE, COOLDOWN). См. SANDBOX_ITERATIONS.md.

---

## Вариант 2: Жёстче выход по микроструктуре + защита по цене

**Дата применения пресета:** 2026-02-07  
**Пресет:** `.env.presets/sandbox_variant2_exit.env`, параметры внесены в `.env`.  
**Депозит:** $1000 (SANDBOX_INITIAL_BALANCE=1000).

**Изменения относительно Варианта 1:**
- SANDBOX_MIN_HOLD_SEC=180 (было 120)
- SANDBOX_EXIT_NONE_TICKS=6 (было 4)
- SANDBOX_MIN_PROFIT_PCT=0.3 (было 0.2)
- SANDBOX_EXIT_WINDOW_TICKS=10, SANDBOX_EXIT_WINDOW_NEED=7 (окно подтверждения выхода)
- Защита по цене как в Варианте 1 (SL 2%, TP 1.5%, breakeven 0.5%, trailing 1%/0.5%)

### Метрики по годам (прогон за ~4 месяца: 2025 + начало 2026)

Источник: `logs/sandbox_trades.csv` после завершения бэктеста.

| Год | Закрытий | Gross PnL | Комиссия | Net PnL | Win rate |
|-----|----------|-----------|----------|---------|----------|
| 2025 | 18 831 | -$18.06 | $864.96 | -$883.01 | 31.3% |
| 2026 | 616 | $10.83 | $11.09 | -$0.25 | 40.3% |
| **Итого** | **19 447** | **-$7.23** | **$876.05** | **-$883.26** | **~31.5%** |

### Разбивка по exit_reason

| Причина выхода | 2025 (сделок / PnL) | 2026 (сделок / PnL) |
|----------------|---------------------|----------------------|
| microstructure | 18 813 / -$36.33 | 608 / $2.75 |
| take_profit | 10 / $19.20 | 6 / $8.14 |
| breakeven | 8 / -$0.92 | 2 / -$0.05 |
| stop_loss | 0 | 0 |
| trailing_stop | 0 | 0 |

Почти все выходы по microstructure; TP и breakeven — единицы, SL и trailing_stop не сработали.

### Как снять метрики после прогона

```bash
python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2025
python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2026
```

### Выводы

**Критерии приёмки НЕ выполнены:**
- Net PnL = -$883.26 (требуется > 0)
- Win rate ≈ 31.5% (требуется ≥ 55%)

**Сравнение с Вариантом 1:** при том же депозите $1000 и похожем периоде Вариант 2 дал меньше закрытий (19 447 vs 21 034), но net PnL хуже (-$883 vs -$90 при $100 депозите в Варианте 1 — разный масштаб комиссии). Структура выходов не изменилась: 99%+ по microstructure, TP/SL/trailing почти не задействованы.

**По критериям из SANDBOX_ITERATIONS.md:** метрики «плоские» (win rate ~31%, структура не меняется) → переходить к **Дальнейшим действиям** (сигнал, контекст, условия запуска), а не к тюнингу Варианта 3.

---

## Прогон 2026-01-07 — 2026-02-07 (context_now primary, 1 месяц тиков)

**Источник:** вывод бэктеста в терминале + `logs/sandbox_trades.csv`, `logs/sandbox_backtest_completed.json`.  
**Пресет:** Дальнейшие действия п.1 (USE_CONTEXT_NOW_PRIMARY=1, синтетический context_now из дельты в бэктесте).

### Параметры

- Период: **2026-01-07 — 2026-02-07** (тики за январь + первые дни февраля).
- Стартовый баланс: **$1000**.
- Отчёт по комиссии: учитываются **open + close** (раньше считали только close — исправлено в `sandbox_backtest_report.py`).

### Метрики (терминал + отчёт)

| Метрика | Значение |
|--------|----------|
| Тиков обработано | 161 279 |
| Сделок (входов + выходов) | 6 552 |
| Входов / Выходов | 3 276 / 3 276 |
| В плюс / В минус | 1 099 / 2 139 |
| **Win rate** | **33.5%** |
| Реализованный PnL | +$30.63 / +$30.64 |
| Комиссия | **$1 085.90** |
| Чистый PnL | **-$1 055.26** |
| Эквити на конец | -$55.26 |

### Разбивка по exit_reason

| Причина выхода | Сделок | PnL |
|----------------|--------|-----|
| microstructure | 3 268 | +$24.37 |
| take_profit | 5 | +$6.42 |
| breakeven | 3 | -$0.15 |

### Выводы

**Критерии приёмки НЕ выполнены:**
- ❌ Net PnL = -$1 055.26 (требуется > 0)
- ❌ Win rate = 33.5% (требуется ≥ 55%)

Gross PnL положительный (+$30.64), но комиссия ($1 085.90) полностью его съедает. Почти все выходы по microstructure (99.7%). Дальше: п.2 (условия запуска, фильтр по тренду/фазе) или снижение числа сделок/объёма.

---

## Прогоны с пересмотром алгоритма (п.5)

### Algorithm rev 1 (параметры в конфиг, пресет sandbox_algorithm_rev1.env)

Параметры: MIN_SCORE=0.4, DELTA_RATIO_MIN=0.2, SWEEP_WEIGHT=0.2, CONFLICT_PENALTY=0.35, MIN_DELTA_IMBALANCE_CONFIRM=0.1. Полный прогон за 1 месяц (2026-01-13 — 2026-02-06): **6 269 закрытий**, win rate 32.8%, gross +$51.97, комиссия $1 255.34, **net -$1 203.37**. Выходы: microstructure 6251, breakeven 12, take_profit 6. Критерии не достигнуты; число сделок осталось высоким.

### Новая логика алгоритма (conflict→none, require_agreement_min=2)

В коде: при конфликте компонентов (delta/imbalance/sweep в разные стороны) — принудительно direction="none"; для long/short требуется не менее 2 согласных компонентов. Конфиг: MICROSTRUCTURE_CONFLICT_MEANS_NONE=True, MICROSTRUCTURE_REQUIRE_AGREEMENT_MIN=-1 (код использует 2). Прогон за 1 месяц даёт **значительно меньше сделок** (по сравнению с 6269). Итоговые метрики — после снятия отчёта: `python bin/sandbox_backtest_report.py --trades logs/sandbox_trades.csv --year 2026`.

---

## Прод-пресет (финальный вариант)

**Дата фиксации:** —  
**Run ID:** —  
**Критерии выполнены:** ✅ / ❌

### Параметры .env

```env
# Песочница: прод-пресет (проверено бэктестом 2023–2025)
SANDBOX_MIN_CONFIDENCE=
SANDBOX_COOLDOWN_SEC=
SANDBOX_MIN_HOLD_SEC=
SANDBOX_EXIT_NONE_TICKS=
SANDBOX_STOP_LOSS_PCT=
SANDBOX_BREAKEVEN_TRIGGER_PCT=
SANDBOX_TAKE_PROFIT_PCT=
SANDBOX_TP_LEVELS=
SANDBOX_TRAIL_TRIGGER_PCT=
SANDBOX_TRAIL_PCT=
SANDBOX_MIN_PROFIT_PCT=
MICROSTRUCTURE_MIN_SCORE=
# ... остальные параметры
```

### Итоговые метрики

*(скопировать из лучшего варианта)*
