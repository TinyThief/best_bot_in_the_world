# Торговые зоны: что реализовано и что добавить (уровень проп-трейдера)

## 1. Что уже реализовано

| Компонент | Описание |
|-----------|----------|
| **Свинг-пивоты** | Локальные минимумы (свинг-лоу) и максимумы (свинг-хай) в окне left/right баров. |
| **Кластеризация** | Близкие по цене уровни объединяются в один (порог в %). Цена уровня — медиана кластера, `touches` — число касаний. |
| **Переключение ролей** | Сопротивление после close выше уровня → поддержка; поддержка после close ниже → сопротивление. |
| **Текущая зона** | zone_low / zone_high (ближайшая поддержка снизу, сопротивление сверху), in_zone, расстояния в %. |
| **Недавние перевороты** | Список уровней, у которых роль сменилась в последних N барах. |
| **Сила уровня** | Упрощённо: `strength = 0.3 + 0.1 * touches` (без объёма и конfluence). |
| **Интеграция** | Зоны по старшему ТФ в multi_tf, лог в bot_loop (зона, поддержка/сопротивление, перевороты). |

Ограничения текущей версии:
- Сила уровня — только по числу касаний, без объёма.
- Нет учёта круглых чисел и конfluence с другими ТФ.
- Уровень — одна цена, без «зоны» (диапазона ±ATR).
- Нет подтверждения пробоя (ретест, объём).
- Нет фильтра «свежесть» (старые уровни не ослабляются).

---

## 2. Что добавить, чтобы определять уровни как проп-трейдер

Ниже — направления улучшений по приоритету и сложности.

---

### 2.1. Объём на уровне (volume at level)

**Зачем:** Уровни, на которых торговался большой объём, часто держатся лучше (зоны накопления/распределения).

**Что сделать:**
- Для каждого свинг-пивота или кластера считать **суммарный объём в зоне** (свечи, чей low–high пересекает уровень в пределах ±0.1% или ±0.5 ATR).
- Добавить в уровень поле `volume_at_level` и учитывать его в **силе уровня**: например, `strength = f(touches, volume_ratio)`, где `volume_ratio = volume_at_level / median(volume_at_level)`.
- Опционально: **VWAP** — расстояние цены до VWAP как отдельный «уровень» (динамический); или использовать VWAP только для конfluence (цена уровня рядом с VWAP = плюс к силе).

**Сложность:** низкая (у нас уже есть OHLCV).

---

### 2.2. Ширина зоны уровня (уровень как диапазон ±ATR)

**Зачем:** Пропы часто работают с зоной, а не с одной ценой: «вход у поддержки» = в пределах 0.3–0.5 ATR от уровня.

**Что сделать:**
- Для каждого уровня хранить не только `price`, но и `zone_low`, `zone_high` (например, `price ± 0.5 * ATR` на баре образования или текущий ATR).
- «Цена у уровня» = цена в [zone_low, zone_high].
- В фильтрах входа и в отчёте использовать «в зоне поддержки/сопротивления» вместо «расстояние до одной цены в %».

**Сложность:** низкая.

---

### 2.3. Круглые числа (psychological levels)

**Зачем:** Круглые уровни (95 000, 100 000, 97 500 для BTC) часто выступают как магнит и S/R.

**Что сделать:**
- Задать шаг круглых уровней (например, 500 или 1000 для BTC).
- Для каждого свинг-уровня проверять: насколько он близок к ближайшему круглому (в % или в ATR). Если близко — добавить к силе уровня бонус `round_number_bonus` или пометить уровень как `near_round`.
- Опционально: добавлять «синтетические» уровни на круглых числах в окрестности текущей цены и считать их слабее (меньший weight), чем уровни, подтверждённые свингами.

**Сложность:** низкая.

---

### 2.4. Сила реакции на уровне (rejection strength)

**Зачем:** Не все касания равны: отбой длинным фитилём и объёмом сильнее, чем касание без реакции.

**Что сделать:**
- При формировании уровня (или при подсчёте touches) для каждого касания оценивать **реакцию**: например, после теста поддержки — рост на следующих N барах (return), длина нижней тени у тестовой свечи; после теста сопротивления — падение, длина верхней тени.
- Ввести `rejection_strength` по уровню (среднее или сумма по касаниям) и учитывать в `strength`.
- Опционально: фильтровать слабые касания (без отбоя) и не считать их полноценным touch.

**Сложность:** средняя.

---

### 2.5. Подтверждение пробоя (ретест, объём)

**Зачем:** Пропы часто ждут ретеста пробитого уровня или всплеска объёма на пробое, чтобы не входить в ложный пробой.

**Что сделать:**
- **Пробой считаем подтверждённым**, если после первого close за уровнем был ретест: цена вернулась к уровню (в зону ±ATR) и снова оттолкнулась (close с нужной стороны). Тогда уже переключать роль уровня.
- Альтернатива или дополнение: переключать роль только если на баре пробоя объём выше среднего (например, `volume > 1.2 * MA(volume, 20)`).
- В уровне хранить `breakout_confirmed` (bool) и при необходимости не использовать уровень как S/R до подтверждения.

**Сложность:** средняя.

---

### 2.6. Свежесть / затухание старых уровней (recency decay)

**Зачем:** Очень старые уровни часто менее релевантны; пропы чаще смотрят на недавние структуры.

**Что сделать:**
- Ввести **recency weight**: например, экспоненциальное затухание от времени (или от индекса бара) образования уровня. Уровни, образованные 100+ баров назад, дают меньший вклад в силу.
- Итоговая `strength = f(touches, volume_at_level, recency_weight, round_number_bonus)`.
- Сортировка уровней для выдачи и для nearest_support/resistance — по этой комплексной силе.

**Сложность:** низкая.

---

### 2.7. Конfluence нескольких таймфреймов

**Зачем:** Один и тот же уровень на 15m, 1h и 4h считается сильнее.

**Что сделать:**
- В multi_tf считать зоны не только по старшему ТФ, но и по 1–2 другим (например, средний и младший). Для каждой пары уровней с разных ТФ: если цены совпадают в пределах порога (например, 0.1%) — считать **confluence**, один «объединённый» уровень с повышенной силой.
- В отчёт добавлять: уровень, список ТФ, на которых он есть, и флаг `multi_tf_confluence`.

**Сложность:** средняя (нужна передача зон с нескольких ТФ и сопоставление по цене).

---

### 2.8. Ликвидность (equal highs/lows, sweep)

**Зачем:** Пропы часто ищут «ликвидность» над равными хаями или под равными лоу; после сбора ликвидности (свип) возможен разворот от уровня.

**Что сделать:**
- Детектировать **equal highs** (несколько свинг-хаев в узком диапазоне) и **equal lows**.
- Помечать уровни: `liquidity_above` / `liquidity_below` (выше/ниже уровня есть «полка» ликвидности).
- Опционально: если после свипа (цена ушла за уровень и вернулась) уровень «держался» — повышать силу уровня или помечать `swept_held`.

**Сложность:** выше средней.

---

### 2.9. Сводная сила уровня (composite strength score)

**Зачем:** Один показатель «насколько уровень сильный» для фильтров и приоритизации.

**Что сделать:**
- Ввести **composite strength** (0..1): взвешенная сумма или формула от:
  - touches (нормализовано),
  - volume_at_level (нормализовано),
  - recency (недавний = выше),
  - round_number_bonus,
  - rejection_strength,
  - multi_tf_confluence (да/нет),
  - при необходимости — liquidity/sweep.
- Использовать composite strength для: сортировки уровней, фильтра «входить только у уровня с strength > 0.5», вывода в лог/Telegram.

**Сложность:** низкая после того, как добавлены отдельные компоненты.

---

## 3. Рекомендуемый порядок внедрения

| Шаг | Улучшение | Эффект |
|-----|-----------|--------|
| 1 | **Объём на уровне** (2.1) | Сильнее уровни там, где был объём — меньше шума. |
| 2 | **Ширина зоны ±ATR** (2.2) | «У уровня» = в зоне, а не одна цена — ближе к практике пропов. |
| 3 | **Круглые числа** (2.3) | Усиление уровней у 95k, 100k и т.д. |
| 4 | **Свежесть/decay** (2.6) | Старые уровни не доминируют. |
| 5 | **Composite strength** (2.9) | Один score для фильтров и приоритета. |
| 6 | **Подтверждение пробоя** (2.5) | Меньше ложных переворотов роли. |
| 7 | **Сила реакции** (2.4) | Уровни с сильным отбоем весят больше. |
| 8 | **Multi-TF confluence** (2.7) | Один уровень на нескольких ТФ = сильнее. |
| 9 | **Ликвидность / sweep** (2.8) | По желанию, для продвинутого сценария. |

После шагов 1–5 система уже заметно ближе к «проповскому» определению уровней; 6–8 повышают точность и фильтрацию.

---

## 4. Кратко

**Уже есть:** свинг-пивоты, кластеризация, переворот ролей S/R, текущая зона, недавние перевороты, базовая сила по touches.

**Имеет смысл добавить в первую очередь:** объём на уровне, зона уровня ±ATR, круглые числа, свежесть уровня, сводный strength — затем подтверждение пробоя, силу реакции и конfluence по ТФ. Так система будет и сильнее, и точнее определять уровни в стиле проп-трейдера.
