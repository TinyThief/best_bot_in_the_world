# Микроструктура рынка и Order Flow — дизайн

## Цель

Модуль анализа **микроструктуры рынка** и **потока ордеров (Order Flow)** для торгового бота и при необходимости для Telegram-бота. Четыре компонента:

1. **DOM (Depth of Market)** — динамика стакана: уровни поддержки/сопротивления по глубине, скопления лимитных ордеров.
2. **Time & Sales (T&S)** — исполненные сделки: объёмы и скорость на ценовых уровнях; всплески объёма = «действие» рынка.
3. **Volume Delta** — разница объёмов на покупку и продажу; положительная дельта на росте = сила быков, отрицательная на падении = сила медведей.
4. **Sweeps** — импульсные движения: фиксация того, как цена «сметает» скопления ордеров в стакане.

---

## 1. DOM (Depth of Market)

**Источник данных:** стакан заявок в реальном времени — уже есть `OrderbookStream` (WebSocket) и REST `get_orderbook`.

**Что анализировать:**
- **Динамика уровней** — значимые ценовые уровни по глубине стакана (скопления лимитных ордеров = потенциальная поддержка/сопротивление).
- **Кластеризация по цене** — объём (size) по уровням; «стена» = уровень с аномально большим объёмом.
- **Bid/Ask imbalance** — соотношение объёма на bid и ask в окне глубины; сдвиг в сторону bid или ask как сигнал давления.
- **Интеграция с trading_zones** — уровни из DOM можно сопоставлять с уровнями из свечей (свинг-пивоты), чтобы усилить или ослабить зоны.

**Выход модуля (предложение):**
- Список «значимых» уровней по стакану (цена, объём, сторона bid/ask, тип: стена / кластер).
- Текущий imbalance (например, ratio или delta в объёме).
- Ближайшие «стены» выше/ниже текущей цены.

**Данные:** снимок стакана `get_snapshot()` от `OrderbookStream`; при необходимости — история снимков за окно времени для динамики.

---

## 2. Time & Sales (исполненные сделки)

**Источник данных:** поток исполненных сделок Bybit — WebSocket topic `publicTrade.{symbol}`. В pybit: `trade_stream(symbol, callback)`.

**Формат сообщения (Bybit V5):**
- `T` — время сделки (мс)
- `s` — символ
- `S` — сторона тейкера: `Buy` | `Sell`
- `v` — объём (размер сделки)
- `p` — цена
- `i` — id сделки
- `seq` — cross sequence
- `L` — направление цены (для Perps/Futures)

**Что анализировать:**
- **Агрегация по времени** — объём за последние N секунд/минут; скорость (объём/сек).
- **Агрегация по уровню** — объём, исполненный на конкретных ценовых уровнях (например, округление до tick); «горячие» уровни.
- **Всплески объёма** — резкое превышение среднего объёма за окно = «действие» рынка (потенциальный разворот или продолжение).

**Выход модуля:**
- Текущий объём за окно (например, 1 мин): total, buy_volume, sell_volume.
- Скорость сделок (объём/сек).
- Флаг «всплеск объёма» (если текущий объём > k * rolling_avg).
- Опционально: распределение объёма по уровням (для связи с DOM и delta).

**Реализация:** новый поток WebSocket для `publicTrade.{symbol}` (аналог `OrderbookStream`) — класс `TradesStream`, накопление сделок в кольцевом буфере за окно; функции анализа T&S по этому буферу.

---

## 3. Volume Delta

**Источник данных:** поток исполненных сделок (Time & Sales). По каждой сделке известна сторона тейкера (`Buy`/`Sell`) и объём `v`.

**Определение:**
- **Delta** = объём покупок (тейкер Buy) − объём продаж (тейкер Sell) за выбранное окно (например, 1 мин, 5 мин или по барам).
- Положительная дельта на росте цены — быки активнее (подтверждение движения).
- Отрицательная дельта на падении цены — медведи активнее (подтверждение движения).
- Дивергенция: цена растёт, дельта отрицательная — слабость быков; цена падает, дельта положительная — слабость медведей.

**Что анализировать:**
- Delta за скользящее окно (время или число последних сделок).
- Кумулятивная дельта за сессию/бар (опционально).
- Сопоставление с движением цены: совпадение направления (тренд + дельта) vs дивергенция.

**Выход модуля:**
- Delta за окно (число), buy_volume, sell_volume.
- Нормализованная метрика (например, delta / total_volume) для сравнения между инструментами.
- Флаги: «бычья дельта», «медвежья дельта», «нейтральная», «дивергенция» (при наличии цены и тренда).

**Зависимости:** поток сделок (TradesStream); при необходимости — текущая цена из стакана или последней сделки.

---

## 4. Sweeps (сметание уровней)

**Суть:** цена кратковременно пробивает скопление ордеров (уровень в стакане или уровень из DOM/свечей), затем возвращается — «сметание» ликвидности, часто перед разворотом или продолжением импульса.

**Источник данных:**
- **Стакан** — уровни с большим объёмом (стены, кластеры); момент, когда цена «задевает» уровень (bid или ask).
- **Свечи** — тени (wick): низкая цена уходит ниже кластера bid, затем закрытие выше = sweep низа; высокая уходит выше кластера ask, закрытие ниже = sweep верха.
- **Сделки (T&S)** — всплеск объёма на уровне при быстром движении цены туда и обратно.

**Что анализировать:**
- **Sweep низа** — цена (low свечи или минимум за окно) ушла ниже значимого уровня (DOM или свинг-лоу), затем отскок (close выше уровня). Фиксируем: уровень, время, объём на уровне (если есть).
- **Sweep верха** — цена ушла выше значимого уровня, затем откат (close ниже уровня).
- Критерии «значимости» уровня: объём в стакане выше порога, или уровень из trading_zones (свинг), или кластер из T&S.

**Выход модуля:**
- События: список недавних sweep’ов (тип: sweep_bid / sweep_ask, уровень, время, опционально объём).
- Для бота: флаг «только что был sweep низа/верха» — можно учитывать в логике входа/выхода (например, после sweep низа — разворот вверх).

**Зависимости:** DOM (уровни стакана), при необходимости — свечи (тени) и/или T&S; окно времени для «недавних» событий.

---

## Данные и инфраструктура

| Компонент   | Источник данных                         | Статус в проекте                    |
|------------|------------------------------------------|-------------------------------------|
| DOM        | OrderbookStream.get_snapshot()           | Есть: orderbook_ws                  |
| Time & Sales | WebSocket publicTrade.{symbol}        | Нет: нужен TradesStream (аналог OrderbookStream) |
| Volume Delta | Поток сделок (Buy/Sell + v)            | После появления TradesStream        |
| Sweeps     | DOM + свечи (тени) и/или T&S             | После DOM и при необходимости T&S   |

**Порядок реализации (предложение):**
1. **TradesStream** в `src/core/` — подписка на `publicTrade.{symbol}`, кольцевой буфер последних N сделок, потокобезопасный `get_recent_trades()`.
2. **orderflow.py** в `src/analysis/`:
   - DOM: анализ снимка стакана (уровни, кластеры, imbalance) — вход от OrderbookStream.
   - T&S: агрегация по окну из TradesStream (объём, скорость, всплески).
   - Volume Delta: по буферу сделок — delta за окно, buy_volume, sell_volume.
   - Sweeps: обнаружение по свечам (тени vs уровни из DOM или trading_zones) и/или по стакану + сделкам.
3. Интеграция в bot_loop или отдельный слой: при наличии OrderbookStream и TradesStream вызывать анализ orderflow и добавлять результат в отчёт (или использовать только при включённой опции).

**Конфиг:** опциональные переменные в .env, например ORDERFLOW_ENABLED, ORDERFLOW_TRADES_WINDOW_SEC, ORDERFLOW_DELTA_WINDOW_SEC, ORDERFLOW_SWEEP_LOOKBACK_BARS — чтобы не нагружать без необходимости.

---

## Связь с текущей системой

- **multi_tf** — сигнал и фильтры по свечам (тренд, фазы, зоны). Order Flow — дополнительный слой: подтверждение или опровержение сигнала по микроструктуре (дельта, sweep, давление в стакане).
- **trading_zones** — уровни по свечам (свинг-пивоты). DOM даёт уровни по стакану; можно объединять (confluence) или использовать DOM для уточнения «силы» уровня.
- **orderbook_ws** — уже есть; используется как вход для DOM и при необходимости для Sweeps.

Полная карта: **STRUCTURE.md**, **AGENT_CONTEXT.md**.
