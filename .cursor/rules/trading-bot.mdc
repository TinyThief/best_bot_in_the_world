---
description: Контекст и правила торгового бота (Bybit, мультиТФ)
alwaysApply: true
---

# Торговый бот для Bybit — правила и структура

## Контекст проекта

- **Цель:** мультитаймфреймовый бот для Bybit (тренд со старшего ТФ, сигнал long/short/none). Пока без исполнения ордеров.
- **Стек:** Python 3.9+, pybit (REST V5), SQLite, python-dotenv, python-telegram-bot.
- **Пара по умолчанию:** BTCUSDT (linear). Конфиг через `.env`, корень проекта — откуда запускаются лаунчеры.

## Структура проекта (целевая)

```
best_bot_in_the_world/
├── src/
│   ├── core/           # config, database, exchange, logging_config
│   ├── analysis/       # market_phases, market_trend (тренд, режим рынка), multi_tf; phase_* (сравнение)
│   ├── app/            # main, bot_loop, db_sync, telegram_bot
│   ├── scripts/        # accumulate_db, backtest_phases, backtest_trend, compare_phase_methods, full_backfill, refill_tf_d, test_run_once
│   └── utils/          # validators, helpers, candle_quality, backtest_chart
├── strategies/         # будущие стратегии (trend_following, scalping и т.д.)
├── tests/
│   ├── unit/
│   ├── integration/
│   └── backtest/
├── data/               # klines.db, при необходимости historical/
├── logs/               # bot.log, signals.log
├── .env, .env.example, .gitignore
├── main.py, telegram_bot.py, refresh_db.py, refill_tf_d.py, catch_up_db.py, ...  # лаунчеры в корне
├── check_all.py, release.py
└── AGENT_CONTEXT.md, ДЛЯ_КОМАНДЫ.md
```

- **Лаунчеры в корне** только поднимают `sys.path` и вызывают код из `src.app` или `src.scripts`. Логику не дублировать.
- **Импорты** между пакетами — относительные: `from ..core import config`, `from .bot_loop import run_one_tick`.

## Безопасность и конфиг

- **Никогда** не хардкодить API-ключи, токены, секреты. Только `os.getenv(...)` / `.env`.
- Конфиг загружать из корня проекта: `PROJECT_ROOT` в `src/core/config.py`, `.env` рядом с проектом.
- В `.gitignore` обязательно: `.env`, `data/`, `logs/`, ключи и секреты.
- Для чтения свечей ключи Bybit не обязательны; для сделок — обязательны.

## Код и стиль

- Type hints для сигнатур функций и возвращаемых значений.
- Имена: snake_case для функций/переменных, PascalCase для классов.
- Сложную логику документировать docstring; модули — кратким описанием в начале файла.
- Модули держать в разумном размере; при разрастании выносить в подмодули или `utils/`.

## Ошибки и ретраи

- Запросы к Bybit оборачивать ретраями при rate limit (429/10006) и сетевых сбоях; экспоненциальная задержка.
- Логировать ошибки с контекстом (модуль, параметры), не только текст исключения.
- Не глотать исключения без логирования; при необходимости пробрасывать дальше.

## Риск и торговля (когда появится исполнение)

- Лимиты позиции (доля от баланса), макс. просадка, стоп-лосс/тейк-профит — задавать в конфиге.
- Перед исполнением проверять баланс и лимиты; не исполнять «вслепую» по сигналу.
- Paper trading и бэктест перед живой торговлей.

## Тесты и проверки

- После изменений запускать `python check_all.py` (при необходимости `-v` или `--quick`).
- Юнит-тесты добавлять в `tests/unit/`, интеграционные — в `tests/integration/`, бэктест-скрипты — в `tests/backtest/` или `src/scripts/`.
- Мокировать биржу и БД в юнит-тестах; не дергать реальный API в обычных прогонах.

## Документация и контекст для AI

- **AGENT_CONTEXT.md** — актуальное состояние: что сделано, в процессе, планируется; куда смотреть по задачам.
- **ДЛЯ_КОМАНДЫ.md** — онбординг: структура, файлы, .env, как запускать.
- При добавлении фич обновлять эти файлы и CHANGELOG при релизах.

## Чего избегать

- Глобального изменяемого состояния для бизнес-логики.
- Игнорирования rate limit и ошибок API.
- Логирования балансов, ключей, персональных данных.
- Хардкода порогов и путей; выносить в конфиг/.env.
- Деплоя в прод без проверки через check_all и без бэктеста/paper trading (когда появятся сделки).
