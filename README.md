# Мультитаймфреймовый торговый бот для Bybit

Бот анализирует несколько таймфреймов по выбранной паре на Bybit и формирует направление (long/short/none) на основе тренда старшего таймфрейма.

## Установка

```bash
cd d:\python3.12.9\MyPythonProjects\best_bot_in_the_world
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt
```

Если команда `python` не находится (Windows), используй полный путь к интерпретатору, например:
`d:\python3.12.9\python.exe -m venv .venv` и т.д.

## Настройка

1. Скопируй `.env.example` в `.env`:

   ```bash
   copy .env.example .env
   ```

2. В `.env` укажи:
   - **BYBIT_API_KEY** / **BYBIT_API_SECRET** — для торговли (для одного чтения свечей можно оставить пустыми).
   - **BYBIT_TESTNET** — `true` для тестнета, `false` для боевой среды.
   - **BYBIT_CATEGORY** — `linear` (USDT‑фьючерсы), `inverse` или `spot`.
   - **SYMBOL** — пара, например `BTCUSDT`.
   - **TIMEFRAMES** — таймфреймы через запятую: `15,60,240` или `1,5,15,60,D`.
   - **POLL_INTERVAL_SEC** — как часто пересчитывать сигнал (в секундах).

## Запуск

**Одноразовая догрузка БД до текущей даты** (если БД давно не обновлялась):

```bash
python bin/catch_up_db.py
```

Скрипт догружает пропущенные свечи от последней в БД до «сейчас» по всем ТФ из `TIMEFRAMES_DB` и выводит дату последней свечи (ТФ D и 60). Для постоянного обновления используй `main.py` или `python bin/accumulate_db.py`.

**Полное обновление БД** — удалить файл БД и заново загрузить все таймфреймы из `TIMEFRAMES_DB` с биржи (актуальные данные, один масштаб):

```bash
python bin/refresh_db.py [--yes]
```

Скрипт запросит подтверждение, затем удалит `data/klines.db` и загрузит историю по каждому ТФ из `.env` (TIMEFRAMES_DB). Перед запуском останови бота (`main.py`, `telegram_bot.py`). Без подтверждения: `--yes`.

**Перезалив только дневного ТФ (D)** — если в БД по ТФ D попали некорректные цены (например миллионы вместо десятков тысяч):

```bash
python bin/refill_tf_d.py
```

Скрипт удаляет все свечи по выбранной паре и ТФ D, затем загружает историю заново с Bybit (с фильтром нереалистичных цен).

**Дозаполнение пропусков в БД** — если на графике виден разрыв (например часть года пропала):

```bash
python bin/fill_gap_db.py
```

Скрипт по всем ТФ из TIMEFRAMES_DB подгружает недостающий диапазон между самой старой и самой новой свечой.

**Накопление базы для обучения** (фьючерс BTC, все таймфреймы):

```bash
python bin/accumulate_db.py
```

При первом запуске скрипт подключается к Bybit, создаёт SQLite-базу `data/klines.db` и по каждому таймфрейму из `TIMEFRAMES_DB` загружает историю (бэкфилл до `BACKFILL_MAX_CANDLES` свечей). Далее в цикле дотягивает новые свечи каждые `DB_UPDATE_INTERVAL_SEC` секунд. Остановка — **Ctrl+C**.

**Сигнальный бот** (анализ по таймфреймам):

```bash
python main.py
```

При старте БД сразу догружается до текущей даты (первый тик), далее обновляется каждые `DB_UPDATE_INTERVAL_SEC` секунд. При заданном в `.env` токене `TELEGRAM_BOT_TOKEN` Telegram-бот запускается из `main.py` в отдельном потоке (общее соединение с БД). Для работы только сигнального бота оставь `TELEGRAM_BOT_TOKEN` пустым.

**Управление через Telegram** (отдельный процесс, если не используешь запуск из main):

```bash
python telegram_bot.py
```

Если `python` не в PATH — выполни `d:\python3.12.9\python.exe telegram_bot.py` из папки проекта.

Нужен токен от [@BotFather](https://t.me/BotFather): создай бота, вставь токен в `.env` как `TELEGRAM_BOT_TOKEN`. Команды: `/start`, `/signal` — полный разбор и фазы по ТФ, `/status` — краткий статус одной строкой, `/db` — статистика БД, `/backtest_phases` — график бэктеста фаз, `/chart` — свечной график (последние 2 года, ТФ D, из БД; при устаревших данных догружается только этот ТФ), `/trend_daily` — тренд по всей БД ТФ D с визуализацией (зоны Вверх/Вниз/Флэт), `/id` — твой user id для TELEGRAM_ALLOWED_IDS, `/help`. Под ответами — кнопки «Обновить» и переключение Сигнал/БД. Ограничение доступа: `TELEGRAM_ALLOWED_IDS=123,456` в `.env`.

## База данных для обучения

- Файл по умолчанию: `data/klines.db` (путь задаётся в `DB_PATH`).
- Таблица `klines`: `symbol`, `timeframe`, `start_time`, `open`, `high`, `low`, `close`, `volume`.
- Один запуск `python bin/accumulate_db.py`: первый проход — бэкфилл по всем ТФ из `TIMEFRAMES_DB`, затем периодическое обновление. Ключи API для чтения свечей не нужны.

В `.env` для накопления можно задать:

- **DB_PATH** — путь к файлу БД.
- **TIMEFRAMES_DB** — таймфреймы через запятую, например `1,3,5,15,30,60,120,240,360,720,D,W,M`.
- **BACKFILL_MAX_CANDLES** — максимум свечей вглубь при первом бэкфилле на один ТФ (по умолчанию 50000).
- **DB_UPDATE_INTERVAL_SEC** — интервал обновления в секундах (по умолчанию 60).

## Версии и выгрузка в GitHub

Что изменилось между версиями — в **[CHANGELOG.md](CHANGELOG.md)**.

Скрипт **release.py** создаёт тег версии, при необходимости коммитит изменения и пушит ветку и теги в `origin`. Так можно откатиться на любую версию.

**Первый раз:** инициализация репозитория и привязка к GitHub:

```bash
git init
git remote add origin https://github.com/<user>/<repo>.git
git add -A
git commit -m "Initial"
```

**Создать версию и выгрузить:**

```bash
python release.py 1.0.0
```

Скрипт закоммитит незакоммиченные изменения с сообщением «Release v1.0.0», создаст тег `v1.0.0` и выполнит `git push origin <текущая_ветка>` и `git push origin v1.0.0`.

**Только тег** (без нового коммита): `python release.py 1.0.1 --tag-only`  
**Локально без push:** `python release.py 1.0.0 --no-push`

**Откат на прошлую версию:**

```bash
git checkout v1.0.0
```

Вернуться на актуальную ветку: `git checkout main` (или имя вашей ветки).

**Список тегов:** `git tag -l`

---

## Структура проекта

Полная карта проекта — **[STRUCTURE.md](STRUCTURE.md)** (дерево, таблицы «по полочкам», где что искать).

Кратко:
- **Запуск бота:** `main.py`, `telegram_bot.py`
- **Работа с БД:** `python bin/catch_up_db.py`, `python bin/fill_gap_db.py`, `python bin/refresh_db.py`, `python bin/refill_tf_d.py`, `python bin/accumulate_db.py`, `python bin/full_backfill.py`
- **Бэктесты:** `python bin/backtest_phases.py`, `python bin/backtest_trend.py`, `python bin/compare_phase_methods.py`, `python bin/test_run_once.py`
- **Тренд по всей БД ТФ D с визуализацией:** `python bin/trend_daily_full.py` — загружает все дневные свечи, считает тренд на полной истории, сохраняет график в `data/trend_daily_D_<SYMBOL>.png` (опции: `--symbol`, `--lookback`, `--max-display`, `--output`)
- **Отчёт по бэктесту тренда:** `python bin/trend_backtest_report.py [--tf D] [--all]` — строит график точности по направлениям (Вверх/Вниз/Флэт), сохраняет в `data/trend_backtest_D.png`
- **Утилиты:** `check_all.py`, `release.py`
- **Код:** `src/core` (конфиг, БД, биржа, db_helper), `src/analysis` (фазы, тренд, мультиТФ), `src/app` (цикл бота, Telegram), `src/scripts` (логика скриптов), `src/utils` (графики, качество свечей)

## Дальнейшие шаги

- Фазы, тренд, режим рынка, фильтры входа, единый score входа (фаза + тренд + ТФ) и проверка качества свечей уже реализованы. Дальше — тонкая настройка порогов и стратегий.
- Реализовать исполнение ордеров через Bybit API при появлении сигнала.
- Ввести риск-менеджмент: размер позиции, стоп-лосс, тейк-профит.
- Поддержка нескольких пар и отдельная конфигурация стратегии под каждую.

## Важно

- Сначала тестируй на **testnet** (`BYBIT_TESTNET=true`).
- Не выкладывай `.env` и реальные ключи в репозиторий.
